<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Langit Falaqyah CBA ‚ú¶ Al-Hikmah v3.5 (Hisab Lengkap)</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Cormorant+Garamond:wght@500;700&display=swap" rel="stylesheet">

<style>
:root {
  --dvh: 100vh;
}
html,body{
  margin:0;padding:0;overflow:hidden;
  height: var(--dvh, 100vh); 
  background:radial-gradient(circle at center,#0a1025 0%,#000010 100%);
  color:#f0e6b2;font-family:'Cormorant Garamond',serif;
  cursor: none;
}
canvas{position:fixed;top:0;left:0;width:100vw;height:var(--dvh, 100vh);z-index:0;}

canvas.interactive-planet {
  cursor: none;
}


#intro,#main{
  position:absolute;top:0;left:0;width:100%;
  height: var(--dvh, 100vh); 
  display:flex;flex-direction:column;
  align-items:center;
  text-align:center;color:#f0e6b2;transition:opacity 2s ease-in-out;z-index:2;
  box-sizing: border-box; 
  overflow-y: auto;
}

#intro {
  padding: 5vh 0;
  pointer-events: auto; 
  justify-content: center; 
  z-index: 4; 
}

/* [PERBAIKAN] Main page bisa di-scroll */
#main {
  justify-content: flex-start; /* Tidak lagi space-between */
  padding: 8vh 0 2vh 0; 
  z-index: 2;
  overflow-y: auto; 
}


#ui-container {
  position: relative;
  z-index: 3; 
  width: 100%;
  /* Hapus height agar bisa di-scroll */
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  pointer-events: none; 
  padding: 8vh 0 2vh 0;
  box-sizing: border-box;
}
#main {
  padding: 0; 
}

#top-group, #bottom-group {
  pointer-events: auto; 
  width: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
}
/* [PERBAIKAN] Bottom group tidak lagi di-push ke bawah */
#bottom-group {
  justify-content: flex-start;
  padding-bottom: 50px; /* Jarak untuk footer */
}


/* judul */
h1{font-family:'Cinzel Decorative',serif;font-size:1.9em;text-shadow:0 0 12px #e8c85a,0 0 22px #b5962b;margin-bottom:0.3em;}
h2{font-size:1.05em;color:#f7e9b4;margin-top:0;text-shadow:0 0 10px #bfa84e;}

.quoteBox{position:relative;height:auto;margin:10px 0;overflow:hidden;max-width:350px; min-height: 60px;}
.quote{width:100%;opacity:0;transform:translateY(20px);
  transition:opacity 2s ease,transform 2s ease; 
  font-size:0.9em;font-style:italic;line-height:1.45;
  color:#fff7d6;text-shadow:0 0 6px #c7a6f;}
.quote.active{opacity:1;transform:translateY(0);}

button{
  font-family:'Cormorant Garamond',serif;background:rgba(255,255,255,0.05);
  border:1px solid #d8c471;border-radius:10px;color:#f5e8b8;
  padding:8px 16px;margin:6px;font-size:1em;backdrop-filter:blur(3px);
  transition:all 0.3s;
  cursor: none; 
  position: relative; 
  overflow: hidden; 
}
button:hover{background:rgba(255,255,255,0.1);transform:scale(1.05);box-shadow:0 0 15px #bfa84e;}

button::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 50%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 230, 180, 0.3), transparent);
  transform: skewX(-25deg);
  animation: shimmer 6s infinite ease-in-out;
  animation-delay: 3s; 
}
@keyframes shimmer {
  0%, 20% { left: -100%; }
  40% { left: 150%; }
  100% { left: 150%; }
}


button.nav-button {
  border-color: #fcefb5;
  color: #fcefb5;
  font-weight: 700;
  width: 90%;
  max-width: 320px;
  margin-top: 10px;
}
button.calculator-button {
  border-color: #88aaff;
  color: #aae0ff;
  text-shadow: 0 0 10px #88aaff;
  width: 90%;
  max-width: 320px;
  margin-top: 15px; /* Kasih jarak dari tombol fitur */
  margin-bottom: 5px; 
  
  background: linear-gradient(145deg, rgba(136, 170, 255, 0.1), rgba(136, 170, 255, 0.05));
  box-shadow: 0 0 15px rgba(136, 170, 255, 0.3);
  animation: pulse-blue 3s infinite ease-in-out;
}
button.calculator-button:hover {
  transform: scale(1.05); 
}
/* Tombol Fitur Ajib */
.feature-btn-set {
  display: flex;
  justify-content: center;
  width: 90%;
  max-width: 320px;
}
button.feature-btn {
  border-color: #ffc471;
  color: #ffd8a8;
  text-shadow: 0 0 8px #ffc471;
  width: 100%; /* Biar bisa 1 baris atau 2 baris */
  background: linear-gradient(145deg, rgba(255, 196, 113, 0.1), rgba(255, 196, 113, 0.05));
  box-shadow: 0 0 15px rgba(255, 196, 113, 0.3);
  animation: pulse-gold 2.5s infinite ease-in-out;
}
button.feature-btn:hover {
  transform: scale(1.05);
}

/* [BARU] Tombol Fitur AI (Pink) */
button.ai-btn {
  border-color: #ffb8d0;
  color: #ffcee0;
  text-shadow: 0 0 8px #ffb8d0;
  width: 100%;
  background: linear-gradient(145deg, rgba(255, 184, 208, 0.1), rgba(255, 184, 208, 0.05));
  box-shadow: 0 0 15px rgba(255, 184, 208, 0.3);
  animation: pulse-pink 2.8s infinite ease-in-out;
}
button.ai-btn:hover {
  transform: scale(1.05);
}

/* [BARU] Styling Fitur Q&A Baru (Warna Cosmic Ungu/Indigo) */
.ai-qa-group {
  width: 90%;
  max-width: 320px;
  margin-bottom: 20px; /* Jarak ke tombol di bawahnya */
  display: flex;
  flex-direction: column;
  align-items: center;
  border: 1px solid #7a42f5;
  border-radius: 12px;
  padding: 10px;
  background: linear-gradient(145deg, rgba(122, 66, 245, 0.1), rgba(122, 66, 245, 0.05));
  box-shadow: 0 0 20px rgba(122, 66, 245, 0.4);
}
.ai-question-input {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1em;
  text-align: center;
  background: rgba(0,0,0,0.4);
  border: 1px solid #c8aaff;
  border-radius: 8px;
  color: #f5e8b8;
  padding: 8px 12px;
  width: 100%;
  box-sizing: border-box;
  margin-bottom: 10px;
  backdrop-filter: blur(3px);
}
.ai-question-input::placeholder {
  color: #c8aaff;
  opacity: 0.8;
  font-style: italic;
}
button.super-ai-btn {
  border-color: #c8aaff;
  color: #e0ceff;
  text-shadow: 0 0 10px #c8aaff;
  width: 100%;
  font-weight: 700;
  background: linear-gradient(145deg, rgba(200, 170, 255, 0.2), rgba(200, 170, 255, 0.1));
  box-shadow: 0 0 15px rgba(200, 170, 255, 0.5);
  animation: pulse-purple 2.8s infinite ease-in-out;
  margin: 0;
}
button.super-ai-btn:hover {
  transform: scale(1.02);
}
.ai-result-box {
  margin-top: 15px;
  background: rgba(0,0,0,0.2);
  border-radius: 8px;
  padding: 12px;
  border: 1px solid #7a42f5;
  color: #e0ceff;
  line-height: 1.6;
  text-align: left;
  font-size: 0.95em;
  width: 100%;
  box-sizing: border-box;
}

@keyframes pulse-blue {
  0%, 100% {
    box-shadow: 0 0 15px rgba(136, 170, 255, 0.3);
    transform: scale(1);
  }
  50% {
    box-shadow: 0 0 25px rgba(136, 170, 255, 0.6);
    transform: scale(1.02);
  }
}
@keyframes pulse-gold {
  0%, 100% {
    box-shadow: 0 0 15px rgba(255, 196, 113, 0.3);
    transform: scale(1);
  }
  50% {
    box-shadow: 0 0 25px rgba(255, 196, 113, 0.6);
    transform: scale(1.02);
  }
}
@keyframes pulse-pink {
  0%, 100% {
    box-shadow: 0 0 15px rgba(255, 184, 208, 0.3);
    transform: scale(1);
  }
  50% {
    box-shadow: 0 0 25px rgba(255, 184, 208, 0.6);
    transform: scale(1.02);
  }
}
@keyframes pulse-purple {
  0%, 100% {
    box-shadow: 0 0 15px rgba(200, 170, 255, 0.5);
    transform: scale(1);
  }
  50% {
    box-shadow: 0 0 25px rgba(200, 170, 255, 0.8);
    transform: scale(1.01);
  }
}


#audioBtn{
  position:fixed;top:12px;right:12px;background:rgba(255,255,255,0.1);
  border:1px solid gold;border-radius:50%;width:32px;height:32px;font-size:16px;
  color:gold;cursor:none; 
  text-shadow:0 0 10px gold;
  display:flex;align-items:center;justify-content:center;
  z-index:10; 
  pointer-events: auto; 
}

.author, #planet-hint {
  opacity:0;
  animation:fadeUp 3s ease forwards;
}
#button-container { animation-delay: 2.2s; opacity: 0; animation: fadeUp 3s ease forwards; } 
.author { animation-delay: 2.5s; }
/* [PERBAIKAN] Footer diposisikan di dalam bottom-group */
footer{
  position: relative;
  margin-top: 30px;
  padding-bottom: 20px;
  font-size:0.75em;
  color:#d3b96f;
  font-family:'Cinzel Decorative',serif; 
  pointer-events: auto;
  opacity:0;
  animation:fadeUp 3s ease forwards;
  animation-delay: 2.5s;
}

#planet-hint { 
  animation-delay: 3s;
  font-size: 0.9em;
  color: #88aaff; 
  text-shadow: 0 0 8px #88aaff;
  margin-top: 5px;
  padding: 0 10px;
} 

@keyframes fadeUp{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
.author{margin-top:10px;font-size:0.85em;color:#d3b96f;}


/* counter ruh */
#visitor-counter {
  margin-top: 20px;
  margin-bottom: 15px;
  text-align: center;
  font-size: 1.05em;
  color: #88aaff;
  text-shadow: 0 0 8px #88aaff;
}

/* --- [BARU] Gerbang Donasi --- */
#donation-info {
  background: rgba(136, 170, 255, 0.05); 
  border: 1px solid #88aaff; 
  border-radius: 10px; 
  padding: 15px; 
  max-width: 320px; 
  width: 90%; 
  box-shadow: 0 0 15px rgba(136, 170, 255, 0.2);
  margin-top: 20px;
  color: #f0e6b2;
}
#donation-info h3 {
  font-family:'Cinzel Decorative',serif; 
  color:#aae0ff; 
  margin:0 0 10px 0;
  font-size: 1.1em;
}
#donation-info p {
  font-size: 0.9em; 
  margin:0 0 10px 0; 
  line-height: 1.5;
}
.donation-account {
  background: rgba(0,0,0,0.2);
  border-radius: 8px;
  padding: 5px 10px;
  margin-bottom: 10px;
}
.donation-account p {
  margin: 5px 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 1em;
}
.copy-btn {
  font-size: 0.8em !important;
  padding: 3px 8px !important;
  margin: 0 0 0 10px !important;
  backdrop-filter: none;
}
#wa-donasi-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  text-decoration: none;
  font-family: 'Cormorant Garamond', serif;
  border: 1px solid #88aaff;
  border-radius: 10px;
  color: #aae0ff;
  padding: 8px 16px;
  margin-top: 10px;
  font-size: 1em;
  width: 90%;
  max-width: 320px;
  text-shadow: 0 0 10px #88aaff;
  background: linear-gradient(145deg, rgba(136, 170, 255, 0.1), rgba(136, 170, 255, 0.05));
  box-shadow: 0 0 15px rgba(136, 170, 255, 0.3);
  animation: pulse-blue 3s infinite ease-in-out;
  transition: all 0.3s;
  cursor: none;
}
#wa-donasi-btn svg {
  width: 16px;
  height: 16px;
  margin-right: 8px;
  fill: #aae0ff;
}
#wa-donasi-btn:hover {
  transform: scale(1.05);
  animation-play-state: paused;
}


/* Gerbang Password */
#password-gate {
  margin-top: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
}
#password-input {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1em;
  text-align: center;
  background: rgba(0,0,0,0.3);
  border: 1px solid #d8c471;
  border-radius: 10px;
  color: #f5e8b8;
  padding: 8px 12px;
  width: 220px;
  backdrop-filter: blur(3px);
  margin-bottom: 10px;
  transition: border-color 0.3s; 
}
#password-input::placeholder {
  color: #d3b96f;
  opacity: 0.7;
}
#password-input.shake {
  animation: shake 0.5s ease-in-out;
}
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  20%, 60% { transform: translateX(-8px); }
  40%, 80% { transform: translateX(8px); }
}

#password-error {
  display: none;
  color: #ff8888;
  text-shadow: 0 0 5px #ff0000;
  margin-top: 5px;
  font-size: 0.9em;
}


/* waktu & info */
#timeInfo{
  margin-top:20px;font-size:1.05em;color:#f5e9c1;text-shadow:0 0 6px #bfa84e;
  line-height: 1.6; 
}
/* Info Jam Haqiqi (BARU) */
#saat-info {
  font-size: 0.85em;
  font-style: italic;
  color: #d3b96f;
  margin-top: 5px;
}

/* Tafsir Energi */
#tafsirInfo {
  margin-top: 15px;
  font-size: 0.95em;
  color: #aae0ff; 
  text-shadow: 0 0 8px #88aaff;
  max-width: 380px;
  padding: 0 10px;
  font-style: italic;
  line-height: 1.5;
}

@keyframes buttonFadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
.button-set {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  align-items: center;
  animation: buttonFadeIn 0.8s ease forwards;
}
.button-set-inactive {
  display: none;
}


/* layar pembuka */
#opening-screen{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:radial-gradient(circle at center,#0a0a18 60%,#000);
  display:flex;flex-direction:column;justify-content:center;align-items:center;
  z-index:9999;color:#f5e9c8;font-family:'Cinzel Decorative',serif;text-align:center;
  transition:opacity 1s ease;
}
#opening-screen h1{font-size:1.8em;text-shadow:0 0 20px #f8e8b5;}
#opening-screen p{margin-top:15px;font-size:1em;font-family:'Cormorant Garamond',serif;}

/* Loading Bar Mistis */
#loading-container {
  width: 220px;
  height: 5px;
  border: 1px solid #d8c471;
  margin-top: 25px;
  border-radius: 5px;
  overflow: hidden;
  background: rgba(0,0,0,0.2);
}
#loading-bar {
  width: 0%;
  height: 100%;
  background: linear-gradient(90deg, #f0e6b2, #b5962b);
  box-shadow: 0 0 10px #f0e6b2;
  border-radius: 5px;
  animation: fillLoading 7s linear forwards;
}
@keyframes fillLoading {
  from { width: 0%; }
  to { width: 100%; }
}

/* Stardust Cursor */
#stardust-cursor {
  position: fixed;
  width: 25px;
  height: 25px;
  background: radial-gradient(circle, rgba(255, 230, 180, 0.6) 0%, rgba(255, 255, 255, 0) 60%);
  border-radius: 50%;
  pointer-events: none;
  transform: translate(-50%, -50%);
  transition: opacity 0.3s, transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  z-index: 10000;
  opacity: 0;
}
#stardust-cursor.hovering-planet {
  transform: translate(-50%, -50%) scale(1.5);
  background: radial-gradient(circle, rgba(255, 215, 100, 0.8) 0%, rgba(255, 255, 255, 0) 70%);
}

body:hover #stardust-cursor {
  opacity: 1;
}

/* modal box */
@keyframes fadeIn{
  from{opacity:0;transform:scale(0.95);}
  to{opacity:1;transform:scale(1);}
}

/* Styling Kalkulator Sa'at */
#saat-calculator-buttons {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  margin-top: 15px;
}
.saat-btn {
  font-size: 0.85em !important;
  padding: 6px 10px !important;
  margin: 4px !important;
  flex-basis: 120px;
}
#saat-calculator-result {
  margin-top: 15px;
  background: rgba(0,0,0,0.2);
  border-radius: 8px;
  padding: 10px;
  border: 1px solid #d8c471;
  color: #aae0ff;
  text-shadow: 0 0 8px #88aaff;
  line-height: 1.6;
}

/* Styling Fitur Ajib */
#birth-calculator, #abjad-calculator, #jodoh-calculator {
  padding: 10px 0;
}
#birth-date-input, #abjad-name-input, .jodoh-input {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1em;
  background: rgba(0,0,0,0.2);
  border: 1px solid #d8c471;
  border-radius: 8px;
  color: #f5e8b8;
  padding: 8px;
  margin: 5px 10px;
  width: 150px;
}
#birth-calculator button, #abjad-calculator button, #jodoh-calculator button {
  font-size: 0.9em !important;
  margin-top: 10px !important;
}
#birth-result, #abjad-result, #jodoh-result {
  margin-top: 15px;
  background: rgba(0,0,0,0.2);
  border-radius: 8px;
  padding: 10px;
  border: 1px solid #88aaff;
  color: #aae0ff;
  line-height: 1.6;
  text-align: left;
}
.jodoh-group {
  border: 1px dashed rgba(255, 196, 113, 0.3);
  padding: 10px;
  border-radius: 8px;
  margin-bottom: 10px;
}
.jodoh-group h4 {
  margin: 0 0 10px 0;
  color: #ffd8a8;
}
.jodoh-input { width: 90%; box-sizing: border-box; }
#jodoh-result h5 {
  color: #ffd8a8;
  margin: 10px 0 5px 0;
  font-size: 1.1em;
}

/* [BARU] Styling Fitur Doa */
#doa-hajat-input {
  width: 90%;
  max-width: 300px;
  background: rgba(0,0,0,0.2);
  border: 1px solid #d8c471;
  border-radius: 8px;
  color: #f5e8b8;
  padding: 8px 12px;
  font-family: 'Cormorant Garamond', serif;
  font-size: 1em;
}
#doa-result {
  margin-top: 15px;
  background: rgba(0,0,0,0.2);
  border-radius: 8px;
  padding: 12px;
  border: 1px solid #ffb8d0;
  color: #ffcee0;
  line-height: 1.6;
  text-align: right;
  font-size: 1.2em;
  direction: rtl;
}

/* [BARU] Loader */
.loader {
  border: 4px solid rgba(255, 255, 255, 0.1);
  border-left-color: #aae0ff;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  animation: spin 1s linear infinite;
  margin: 15px auto 0 auto;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}


/* Petuah */
.petuah {
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid rgba(255, 196, 113, 0.3);
  color: #ffd8a8;
  font-style: italic;
}


/* [MIND BLOWING] Tombol Live Chat WA */
#live-chat-btn {
  position: fixed;
  bottom: 25px;
  right: 25px;
  width: 50px;
  height: 50px;
  background: radial-gradient(circle, rgba(255, 215, 130, 0.2), rgba(216, 196, 113, 0.1));
  border: 1px solid #d8c471;
  border-radius: 50%;
  color: #fcefb5;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 100;
  pointer-events: auto;
  cursor: none;
  backdrop-filter: blur(4px);
  animation: pulse-gold 2.5s infinite ease-in-out;
  transition: all 0.3s;
}
#live-chat-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 0 20px #fcefb5;
  animation-play-state: paused;
}


/* responsif */
@media (max-width:600px){
  h1{font-size:1.5em;}
  .quote{font-size:0.85em;}
  button{font-size:0.9em;padding:6px 10px;margin:4px;}
  #audioBtn{width:28px;height:28px;font-size:14px;top:10px;right:10px;}
  #timeInfo{font-size:0.9em;margin-top:10px;}
  #tafsirInfo{font-size: 0.85em; margin-top: 10px;} 
  #planet-hint{font-size: 0.8em;}
  #visitor-counter{font-size:0.9em;}
  .quoteBox{max-width: 90%;}
  modalBox{max-width: 90%;}
  
  #ui-container {
    padding-top: 5vh;
    padding-bottom: 2vh;
  }
  #intro {
    justify-content: flex-start; /* Mulai dari atas */
    padding: 10vh 0; /* Kasih padding atas-bawah */
  }
  
  #stardust-cursor { display: none; }
  body { cursor: auto; }
  button, #audioBtn, #live-chat-btn, #wa-donasi-btn { cursor: pointer; }
  canvas { cursor: default; }

  #live-chat-btn {
    width: 45px;
    height: 45px;
    bottom: 20px;
    right: 20px;
  }
  
  #donation-info {
    max-width: 90%;
  }
  
  #birth-calculator, #abjad-calculator, #jodoh-calculator {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  #birth-date-input, #abjad-name-input, .jodoh-input {
    width: 90%;
    margin: 5px 0 10px 0;
  }
  .feature-btn-set {
    flex-direction: column;
    max-width: 90%;
  }
  button.feature-btn, button.ai-btn {
    width: 100%;
    margin-bottom: 5px;
  }
  
  /* Responsive untuk QA Group */
  .ai-qa-group {
    max-width: 90%;
    padding: 8px;
  }
  .ai-question-input, button.super-ai-btn, .ai-result-box {
    width: 100%;
  }
}
</style>
</head>
<body>
  <div id="opening-screen">
  <h1>‚ú¶ SEDANG MEMBUKA LANGIT DAN WAKTU ‚ú¶</h1>
  <p>TUNGGULAH SEJENAK HINGGA TABIR FALAK TERBUKA...</p>
  <div id="loading-container">
    <div id="loading-bar"></div>
  </div>
</div>

<canvas id="universe"></canvas>

<div id="intro" style="opacity:0;pointer-events:none;">
  <h1>ÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸëŸ∞ŸáŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸ∞ŸÜŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸêŸäŸíŸÖŸê</h1>
  <p class="quote">"Langit dan waktu adalah cermin ketetapan, tempat ruh menapaki garis takdir."</p>
  
  <div id="visitor-counter" class="auratik-counter">
    ‚ú¶ Jumlah Ruh yang Telah Menatap Langit Ini: <span id="visitor-count">...</span> ‚ú¶
  </div>
  
  <div id="donation-info">
    <h3 style="font-family:'Cinzel Decorative',serif; color:#aae0ff; margin:0 0 10px 0;">Donasi untuk Kode Rahasia</h3>
    <p style="font-size: 0.9em; margin:0 0 10px 0; line-height: 1.5;">Untuk mendapat Kode Rahasia, silakan donasi seikhlasnya. Anda akan menerima Kode via WhatsApp setelah mengirim bukti transfer.</p>
    
    <div class="donation-account">
      <p>
        <b>Seabank:</b> 901311854079 (Endri)
        <button class="copy-btn" onclick="copyToClipboard('901311854079')">Salin</button>
      </p>
    </div>
    <div class="donation-account">
      <p>
        <b>Dana:</b> 085173262649 (Empi Sopiah)
        <button class="copy-btn" onclick="copyToClipboard('085173262649')">Salin</button>
      </p>
    </div>

    <a id="wa-donasi-btn" href="https://wa.me/6285173262649?text=Assalamu'alaikum,%20saya%20sudah%20donasi%20untuk%20Langit%20Falaqyah.%20Ini%20bukti%20transfernya." target="_blank">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/></svg>
      Kirim Bukti via WhatsApp
    </a>
  </div>

  <div id="password-gate">
    <input type="password" id="password-input" placeholder="Masukkan Kode Rahasia...">
    <button id="unlock-btn">Buka Tabir</button>
    <p id="password-error"></p>
  </div>
</div>

<div id="main" style="opacity:0;pointer-events:none;">
  
  <div id="ui-container">
    <div id="top-group">
      <h1 style="margin-top:0;">Perhitungan Falaqiyah <span style="white-space: nowrap;">Al-Hikmah</span></h1> 
      <h2>ÿ≥ÿ± ÿßŸÑŸàŸÇÿ™ ‚Äî Rahasia Waktu</h2>
      
      <div class="quoteBox" id="quoteBox">
        <div class="quote active" id="quoteText">
          ‚ÄúHari-hari dalam sepekan berada di bawah kekuasaan planet-planet; tiap hari memiliki tabiat serta pengaruhnya masing-masing.‚Äù<br>
          <small>‚Äî <i>Shams al-Ma‚ÄòƒÅrif</i></small>
        </div>
      </div>
    </div>

    <div id="bottom-group">
      <div id="timeInfo">
        <span id="hijriah">...</span><br> 
        üåû Penguasa Hari: <span id="hari">...</span><br>
        ‚è≥ Planet Jam Aktif: <span id="planet">...</span><br>
        üïí <span id="jam">...</span><br>
        <small>‚òÄ Pergantian Penguasa Hari: <span id="sunrise-time">...</span></small><br>
        <small id="saat-info">Durasi Jam Sa'at: memuat...</small>
      </div>

      <div id="tafsirInfo">
        Tafsir Saat Ini: <span id="tafsir-text">...</span>
      </div>
      
      <p id="planet-hint" class="author">‚ú¶ Coba klik planet di langit untuk melihat info energinya ‚ú¶</p>

      <div id="button-container" style="margin-top:20px;">
        
        <div id="new-ai-container" class="ai-qa-group"> 
            <input type="text" id="falak-question-input" placeholder="Tanyakan apa saja tentang Waktu & Falakiyah..." class="ai-question-input">
            <button id="ask-falak-btn" class="super-ai-btn">Tanya Langit ‚ú¶</button>
            <div id="falak-result" class="ai-result-box" style="display:none;"></div>
        </div>
        <div class="feature-btn-set">
          <button class="feature-btn">üåü Kalkulator Energi Lahir</button>
          <button class="feature-btn">üß≠ Kalkulator Arah Hajat</button>
        </div>
        <div class="feature-btn-set">
          <button class="feature-btn">üî¢ Hisab Nama (Abjad)</button>
          <button class="ai-btn">üíò Hisab Jodoh</button> </div>
        <div class="feature-btn-set">
          <button class="ai-btn">‚ú® Buat Do'a Hajat</button> </div>
        
        <button class="calculator-button">üîÆ Kalkulator Sa'at</button> 

        <div id="button-set-1" class="button-set">
          <button>üïØ Sa‚Äôat Amal</button>
          <button>üå† Waktu Mustajab</button>
          <button>üïä Do‚Äôa & Niat</button>
          <button>üìú Info Falakiyah</button>
          <button>ü™∂ Perhitungan Falaqiyah</button>
        </div>
        
        <button class="nav-button">Amalan Lanjutan ‚ùØ</button>
        
        <div id="button-set-2" class="button-set button-set-inactive">
          <button>üóù Ritual Khusus</button>
          <button>‚ú® Asma' Falakiyah</button>
          <button>üìú Wafaq & Rajah</button>
          <button>üí¨ Konsultasi Batin</button>
          <button class="nav-button">‚ùÆ Halaman Utama</button>
        </div>

      </div>

      <div class="author">Diprakarsai oleh : Endry Arya</div>
      <footer>¬© CBA2025</footer> </div>
  </div> 
  
</div>

<div id="audioBtn">üîä</div>

<a id="live-chat-btn" href="https://wa.me/6285173262649" target="_blank" title="Live Chat via WhatsApp">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #fcefb5;">
    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
  </svg>
</a>

<div id="stardust-cursor"></div>

<audio id="music" loop>
  <source src="music.mp3" type="audio/mpeg">
</audio>
<audio id="chime" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_c07f4f3101.mp3?filename=chime-magic-6107.mp3"></audio>


<script>
// Perbaikan Firefox layout
function setDynamicViewportHeight() {
  let vh = window.innerHeight;
  document.documentElement.style.setProperty('--dvh', `${vh}px`);
}
window.addEventListener('load', setDynamicViewportHeight);
window.addEventListener('resize', setDynamicViewportHeight);

// [BARU] Notifikasi Copy (Anti-Alert)
function showCopyNotification(text) {
  const notif = document.createElement('div');
  notif.style = `
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #fcefb5;
    color: #0a1025;
    padding: 10px 20px;
    border-radius: 8px;
    z-index: 10001;
    font-family: 'Cormorant Garamond', serif;
    font-size: 1em;
    box-shadow: 0 0 15px rgba(255,255,255,0.5);
    opacity: 0;
    transition: all 0.5s;
    pointer-events: none;
  `;
  notif.textContent = text;
  document.body.appendChild(notif);
  
  setTimeout(() => { notif.style.opacity = '1'; notif.style.top = '30px'; }, 10);
  setTimeout(() => {
    notif.style.opacity = '0';
    notif.style.top = '20px';
    setTimeout(() => notif.remove(), 500);
  }, 3000);
}

// [BARU] Fungsi Copy
function copyToClipboard(text) {
  const el = document.createElement('textarea');
  el.value = text;
  el.style.position = 'absolute';
  el.style.left = '-9999px';
  document.body.appendChild(el);
  el.select();
  try {
    document.execCommand('copy');
    showCopyNotification('Nomor rekening disalin: ' + text);
  } catch (err) {
    showCopyNotification('Gagal menyalin. Salin manual.');
  }
  document.body.removeChild(el);
}

const music=document.getElementById("music");
const audioBtn=document.getElementById("audioBtn");
let showPlanets=false; 

setTimeout(()=>{
  const opening=document.getElementById('opening-screen');
  if (opening) {
    opening.style.opacity='0';
    setTimeout(()=>{
      opening.remove();
      const intro=document.getElementById('intro');
      if (intro) {
        intro.style.opacity='1';
        intro.style.pointerEvents='auto';
      }
    },1000);
  }
},7000); 

function startMain(){
  const intro = document.getElementById('intro');
  if (intro) {
    intro.style.opacity='0';
    intro.style.pointerEvents='none'; 
    setTimeout(()=>{
      intro.style.display='none';
      const main=document.getElementById('main');
      if (main) {
        main.style.opacity='1';
      }
      showPlanets=true; 
      setTimeout(initQuotes,2000); 
      
      music.play().catch(e => console.log("Autoplay musik diblokir, menunggu interaksi."));
      audioBtn.style.boxShadow="0 0 18px gold"; 
      
    },1500);
  }
}

// Logika Gerbang Password
const unlockBtn = document.getElementById('unlock-btn');
const passwordInput = document.getElementById('password-input'); 

if (unlockBtn) {
  unlockBtn.onclick = () => {
    const errorMsg = document.getElementById('password-error');
    if (passwordInput.value.toUpperCase() === 'CBA26') {
      startMain();
    } else {
      errorMsg.textContent = 'Kode Rahasia Salah.';
      errorMsg.style.display = 'block';
      passwordInput.style.borderColor = '#ff8888';
      passwordInput.classList.add('shake');
      setTimeout(() => passwordInput.classList.remove('shake'), 500);
      if (navigator.vibrate) navigator.vibrate(100);
    }
  };
  passwordInput.oninput = () => {
    document.getElementById('password-error').style.display = 'none';
    passwordInput.style.borderColor = '#d8c471';
  };
}


// Audio Manual Klik
document.body.addEventListener('click',()=>{ 
  if(music.paused && document.getElementById('main').style.opacity === '1') {
    music.play();
    audioBtn.style.boxShadow="0 0 18px gold";
  }
},{once:true});

audioBtn.onclick=()=>{
  if(music.paused){
    music.play();
    audioBtn.style.boxShadow="0 0 18px gold";
    audioBtn.textContent = 'üîä';
  } else {
    music.pause();
    audioBtn.style.boxShadow="0 0 6px rgba(180,160,255,0.4)";
    audioBtn.textContent = 'üîá';
  }
};

function initQuotes(){
  const el=document.getElementById('quoteText');
  if (!el) return;
  const quotes=[
    "‚ÄúHari-hari dalam sepekan berada di bawah kekuasaan planet-planet; tiap hari memiliki tabiat serta pengaruhnya masing-masing.‚Äù<br><small>‚Äî <i>Shams al-Ma‚ÄòƒÅrif</i></small>",
    "‚ÄúSetiap jam memiliki planet yang berkuasa padanya; maka lakukanlah amal pada waktu planetnya, niscaya engkau memperoleh keberkahannya.‚Äù<br><small>‚Äî <i>Shams al-Ma‚ÄòƒÅrif</i></small>"
  ];
  let i=0;
  setInterval(()=>{
    el.classList.remove('active');
    setTimeout(()=>{
      i=(i+1)%quotes.length;
      el.innerHTML=quotes[i];
      el.classList.add('active');
    },2000); 
  },12000); 
}

// ==================================================
// [ROMBAKAN TOTAL] MESIN HISAB HAQIQI v3.5
// ==================================================

const planetHari = ["Syams","Qamar","Marƒ´kh","UtƒÅrid","Musytarƒ´","Zuhrah","Zuhal"]; 
const chaldeanOrder = ["Zuhal", "Musytarƒ´", "Marƒ´kh", "Syams", "Zuhrah", "UtƒÅrid", "Qamar"];

// [MIND BLOWING] Obyek Tafsir Ijtima' (Pertemuan)
const ijtimaTafsir = {
  "Syams": { // Hari Kewibawaan
    "Zuhal": "Energi Wibawa (Hari) bertemu Energi Keras (Jam). *Sa'at al-Jalal* (Waktu Keagungan & Batasan). Kuat untuk membuat pagar gaib, menanam keteguhan, atau memberi peringatan keras (Halak) yang berwibawa.",
    "Musytarƒ´": "Energi Wibawa (Hari) bertemu Energi Rezeki (Jam). *Sa'at al-Rifa'ah* (Waktu Ketinggian). Waktu terbaik untuk memohon kenaikan pangkat, kelapangan rezeki, dan kemuliaan dari para pembesar.",
    "Marƒ´kh": "Energi Wibawa (Hari) bertemu Energi Kuat (Jam). *Sa'at al-Qahr* (Waktu Penaklukan). Sangat kuat untuk menaklukkan musuh, memenangkan kompetisi, atau amalan kewibawaan tingkat tinggi (menundukkan).",
    "Syams": "Energi Wibawa (Hari) bertemu Energi Wibawa (Jam). *Sa'at al-Sultan* (Waktu Raja). Ini adalah Puncak Kewibawaan. Waktu terbaik menghadap penguasa, memohon jabatan, atau amalan kemuliaan tertinggi.",
    "Zuhrah": "Energi Wibawa (Hari) bertemu Energi Harmoni (Jam). *Sa'at al-Jamal* (Waktu Keindahan & Wibawa). Sangat baik untuk 'Pelet' (Mahabbah) tingkat tinggi, agar dicintai sekaligus disegani.",
    "UtƒÅrid": "Energi Wibawa (Hari) bertemu Energi Komunikasi (Jam). *Sa'at al-Khitabah* (Waktu Pidato). Waktu terbaik untuk pidato, presentasi, negosiasi, agar ucapan didengar dan berwibawa.",
    "Qamar": "Energi Wibawa (Hari) bertemu Energi Perasaan (Jam). *Sa'at al-Kasyf* (Waktu Penyingkapan). Baik untuk membuka mata batin (Kasyf) atau memohon agar rahsia-rahsia kemuliaan dibukakan."
  },
  "Qamar": { // Hari Perasaan
    "Zuhal": "Energi Perasaan (Hari) bertemu Energi Keras (Jam). *Sa'at al-Qabdh* (Waktu Kesempitan). Hati bisa terasa berat/was-was. Sangat baik untuk penjagaan batin, membuat pagar gaib, atau ritual *pemisah* (Tafriq).",
    "Musytarƒ´": "Energi Perasaan (Hari) bertemu Energi Rezeki (Jam). *Sa'at al-Ijabah* (Waktu Terkabul). Baik untuk memohon rezeki yang lembut & menenangkan hati, atau dari jalur yang tidak terduga.",
    "Marƒ´kh": "Energi Perasaan (Hari) bertemu Energi Kuat (Jam). *Sa'at al-Ghadab* (Waktu Amarah). Hati-hati, emosi (Qamar) bertemu Api (Marikh). Emosi bisa meledak. Hindari pertengkaran.",
    "Syams": "Energi Perasaan (Hari) bertemu Energi Wibawa (Jam). *Sa'at al-Ilham* (Waktu Ilham). Baik untuk amalan spiritual, membuka intuisi (Qamar) untuk menerima cahaya (Syams) ilham.",
    "Zuhrah": "Energi Perasaan (Hari) bertemu Energi Harmoni (Jam). *Sa'at al-Mahabbah* (Waktu Cinta Kasih). Waktu terbaik untuk amalan kasih sayang, perdamaian, dan menenangkan hati yang gelisah.",
    "UtƒÅrid": "Energi Perasaan (Hari) bertemu Energi Komunikasi (Jam). *Sa'at al-Syi'r* (Waktu Sastra/Sihir). Sangat kuat untuk menulis (terutama yg puitis/magis), atau amalan 'kata-kata' (ucapan memikat).",
    "Qamar": "Energi Perasaan (Hari) bertemu Energi Perasaan (Jam). *Sa'at al-Bathin* (Waktu Batin). Puncak Energi Batin. Waktu terbaik untuk amalan intuisi, mimpi gaib, atau hal-hal yang tersembunyi."
  },
  "Marƒ´kh": { // Hari Kekuatan
    "Zuhal": "Energi Kuat (Hari) bertemu Energi Keras (Jam). *Sa'at al-Intiqam* (Waktu Pembalasan). Waktu paling merusak. Sangat kuat untuk Halak, serangan balik, atau ritual pemisah (Tafriq) yang keras.",
    "Musytarƒ´": "Energi Kuat (Hari) bertemu Energi Rezeki (Jam). *Sa'at al-Ghanimah* (Waktu Harta Rampasan). Kuat untuk 'merebut' peluang rezeki, memenangkan tender, atau menagih hutang dengan tegas.",
    "Marƒ´kh": "Energi Kuat (Hari) bertemu Energi Kuat (Jam). *Sa'at al-Harb* (Waktu Perang). Puncak Energi Kekuatan. Waktu terbaik untuk amalan kekebalan, menaklukkan musuh/jin, atau pekerjaan fisik yang sangat berat.",
    "Syams": "Energi Kuat (Hari) bertemu Energi Wibawa (Jam). *Sa'at al-Syaja'ah* (Waktu Keberanian). Sangat baik untuk meningkatkan keberanian, menaikkan wibawa ketentaraan/kepolisian, atau menaklukkan atasan.",
    "Zuhrah": "Energi Kuat (Hari) bertemu Energi Harmoni (Jam). *Sa'at al-Syahwah* (Waktu Syahwat). Energi Api (Marikh) bertemu Cinta (Zuhrah). Sangat kuat untuk ritual 'Pelet' (Mahabbah) yang bersifat pemaksaan.",
    "UtƒÅrid": "Energi Kuat (Hari) bertemu Energi Komunikasi (Jam). *Sa'at al-Jidal* (Waktu Debat). Waktu yang tajam untuk berdebat, mematahkan argumen lawan, atau membuat tulisan yang 'menyerang'.",
    "Qamar": "Energi Kuat (Hari) bertemu Energi Perasaan (Jam). *Sa'at al-Hadas* (Waktu Insting Tajam). Insting (Qamar) menjadi setajam pedang (Marikh). Baik untuk melatih insting tempur atau proteksi.",
  },
  "UtƒÅrid": { // Hari Komunikasi
    "Zuhal": "Energi Akal (Hari) bertemu Energi Keras (Jam). *Sa'at al-Hifz* (Waktu Menghafal). Baik untuk mengunci ingatan/hafalan, membuat rajah/wafaq yang bersifat 'mengunci', atau penjagaan surat.",
    "Musytarƒ´": "Energi Akal (Hari) bertemu Energi Rezeki (Jam). *Sa'at al-Tijarah* (Waktu Perdagangan). Waktu terbaik untuk negosiasi bisnis, jual-beli, tanda tangan kontrak, atau memulai dagang.",
    "Marƒ´kh": "Energi Akal (Hari) bertemu Energi Kuat (Jam). *Sa'at al-Mantiq* (Waktu Logika Tajam). Baik untuk memecahkan masalah rumit, debat kusir, atau menyusun strategi (perang/bisnis).",
    "Syams": "Energi Akal (Hari) bertemu Energi Wibawa (Jam). *Sa'at al-Bayan* (Waktu Penjelasan). Waktu terbaik untuk mengajar, presentasi di depan umum, atau agar ucapan (Utarid) didengar oleh pembesar (Syams).",
    "Zuhrah": "Energi Akal (Hari) bertemu Energi Harmoni (Jam). *Sa'at al-Fann* (Waktu Seni). Sangat baik untuk menulis surat cinta, puisi, lirik lagu, atau komunikasi yang bersifat mendamaikan.",
    "UtƒÅrid": "Energi Akal (Hari) bertemu Energi Akal (Jam). *Sa'at al-Dzikra* (Waktu Kecerdasan). Puncak Energi Akal. Waktu terbaik untuk belajar, menghafal, menulis kitab, atau ritual kecerdasan.",
    "Qamar": "Energi Akal (Hari) bertemu Energi Perasaan (Jam). *Sa'at al-Hikayah* (Waktu Cerita). Baik untuk 'meramal' (tarot/pasir), menulis fiksi, atau komunikasi yang menyentuh perasaan (hipnosis).",
  },
  "Musytarƒ´": { // Hari Rezeki
    "Zuhal": "Energi Rezeki (Hari) bertemu Energi Keras (Jam). *Sa'at al-Kanz* (Waktu Harta Karun). Baik untuk 'mengunci' harta/aset, menabung, investasi jangka panjang (properti/tanah), atau penjagaan bisnis.",
    "Musytarƒ´": "Energi Rezeki (Hari) bertemu Energi Rezeki (Jam). *Sa'at al-Barakah* (Waktu Keberkahan). Puncak Energi Rezeki. Waktu terbaik untuk memulai usaha apapun, memohon kelapangan rezeki, atau sedekah.",
    "Marƒ´kh": "Energi Rezeki (Hari) bertemu Energi Kuat (Jam). *Sa'at al-Iqtidar* (Waktu Kemampuan). Baik untuk mencari rezeki yang butuh 'kekuatan' (menagih hutang, memenangkan tender) atau rezeki dalam jumlah besar.",
    "Syams": "Energi Rezeki (Hari) bertemu Energi Wibawa (Jam). *Sa'at al-Tsaurah* (Waktu Kekayaan). Waktu terbaik untuk memohon rezeki yang besar (Musytari) sekaligus kemuliaan (Syams) atau rezeki dari penguasa.",
    "Zuhrah": "Energi Rezeki (Hari) bertemu Energi Harmoni (Jam). *Sa'at al-Ni'mah* (Waktu Kenikmatan). Baik untuk rezeki yang bersifat 'nikmat' (bisnis kuliner, fashion, seni) atau menikmati hasil jerih payah.",
    "UtƒÅrid": "Energi Rezeki (Hari) bertemu Energi Akal (Jam). *Sa'at al-Fulus* (Waktu Uang). Waktu terbaik untuk perdagangan, marketing, atau mencari rezeki yang mengandalkan kecerdasan (Utarid).",
    "Qamar": "Energi Rezeki (Hari) bertemu Energi Perasaan (Jam). *Sa'at al-Hadaya* (Waktu Hadiah). Baik untuk memohon rezeki dari jalur tak terduga (Qamar) atau rezeki yang bersifat 'hadiah'/'bonus'.",
  },
  "Zuhrah": { // Hari Harmoni
    "Zuhal": "Energi Harmoni (Hari) bertemu Energi Keras (Jam). *Sa'at al-'Ahd* (Waktu Ikatan). Baik untuk amalan 'mengikat' pasangan (Zuhrah) secara 'keras' (Zuhal), atau membuat hubungan awet/tertutup.",
    "Musytarƒ´": "Energi Harmoni (Hari) bertemu Energi Rezeki (Jam). *Sa'at al-Farah* (Waktu Kebahagiaan). Waktu terbaik untuk pernikahan, pesta, atau memulai bisnis yang berhubungan dengan keindahan/kesenangan.",
    "Marƒ´kh": "Energi Harmoni (Hari) bertemu Energi Kuat (Jam). *Sa'at al-Syahwah* (Waktu Syahwat). Energi Api (Marikh) bertemu Cinta (Zuhrah). Sangat kuat untuk ritual 'Pelet' (Mahabbah) yang bersifat pemaksaan.",
    "Syams": "Energi Harmoni (Hari) bertemu Energi Wibawa (Jam). *Sa'at al-Zinah* (Waktu Perhiasan). Baik untuk amalan 'susuk', membuka aura (Zuhrah) agar terlihat agung (Syams) dan disukai pembesar.",
    "Zuhrah": "Energi Harmoni (Hari) bertemu Energi Harmoni (Jam). *Sa'at al-'Isyq* (Waktu Asmara). Puncak Energi Cinta. Waktu terbaik untuk amalan Mahabbah (pengasihan), perdamaian, atau bersolek.",
    "UtƒÅrid": "Energi Harmoni (Hari) bertemu Energi Akal (Jam). *Sa'at al-Lathifah* (Waktu Kelembutan). Baik untuk diplomasi, merayu (lisan/tulisan), atau menenangkan orang yang sedang marah.",
    "Qamar": "Energi Harmoni (Hari) bertemu Energi Perasaan (Jam). *Sa'at al-Unfuwan* (Waktu Kerinduan). Waktu terbaik untuk amalan 'pengasihan' jarak jauh, atau agar dirindukan (Qamar) oleh target (Zuhrah).",
  },
  "Zuhal": { // Hari Kekerasan
    "Zuhal": "Energi Keras (Hari) bertemu Energi Keras (Jam). *Sa'at al-Mawt* (Waktu Kematian/Akhir). Puncak Energi Keras. Waktu terkuat untuk Halak, memutus (Tafriq), atau mengunci total (pagar gaib).",
    "Musytarƒ´": "Energi Keras (Hari) bertemu Energi Rezeki (Jam). *Sa'at al-Milk* (Waktu Kepemilikan). Waktu terbaik untuk urusan tanah, properti, pertanian, atau 'mengunci' rezeki/aset (warisan).",
    "Marƒ´kh": "Energi Keras (Hari) bertemu Energi Kuat (Jam). *Sa'at al-Damm* (Waktu Darah). Energi Keras (Zuhal) bertemu Api (Marikh). Waktu terkuat kedua untuk Halak, merusak, atau mengirim serangan balik.",
    "Syams": "Energi Keras (Hari) bertemu Energi Wibawa (Jam). *Sa'at al-Hadd* (Waktu Batasan). Baik untuk membuat pagar gaib (Zuhal) yang berwibawa (Syams) atau memberi 'batasan' pada musuh/penguasa.",
    "Zuhrah": "Energi Keras (Hari) bertemu Energi Harmoni (Jam). *Sa'at al-Tafriq* (Waktu Pemisah). Energi Pemisah (Zuhal) bertemu Cinta (Zuhrah). Waktu terkuat untuk ritual pemisah hubungan (Tafriq).",
    "UtƒÅrid": "Energi Keras (Hari) bertemu Energi Akal (Jam). *Sa'at al-Sijn* (Waktu Penjara). Baik untuk 'mengunci' lisan (Utarid) musuh, membuat wafaq/rajah penjagaan (Zuhal), atau amalan yang butuh fokus tinggi.",
    "Qamar": "Energi Keras (Hari) bertemu Energi Perasaan (Jam). *Sa'at al-Waswas* (Waktu Keraguan). Energi Keras (Zuhal) bertemu Batin (Qamar). Bisa bikin was-was. Tidak baik untuk memulai. Baik untuk mengirim 'was-was' ke musuh."
  }
};

// [MIND BLOWING] Fungsi baru untuk Tafsir Ijtima'
function getTafsirIjtima(planetHari, planetJam) {
  if (ijtimaTafsir[planetHari] && ijtimaTafsir[planetHari][planetJam]) {
    return ijtimaTafsir[planetHari][planetJam];
  }
  // Fallback jika ada error (seharusnya tidak terjadi)
  return `Energi ${planetHari} (Hari) bertemu Energi ${planetJam} (Jam).`;
}


// Variabel global untuk data falak
let lat = -6.595018; // Default Bogor
let lon = 106.815025; // Default Bogor
let sunriseTime = 5.75; // 05:45
let sunsetTime = 17.75; // 17:45
let sunriseTomorrow = 5.76;
let durasiJamSaatSiang = 60;
let durasiJamSaatMalam = 60;

const hariElem=document.getElementById('hari');
const planetElem=document.getElementById('planet');
const jamElem=document.getElementById('jam');
const hijriahElem=document.getElementById('hijriah'); 
const tafsirElem=document.getElementById('tafsir-text'); 
const sunriseElem=document.getElementById('sunrise-time');
const saatInfoElem=document.getElementById('saat-info');

function formatJam(jamDesimal) {
    const totalMenit = Math.floor(jamDesimal * 60);
    const jam = Math.floor(totalMenit / 60) % 24; 
    const menit = totalMenit % 60; 
    return `${jam < 10 ? '0' + jam : jam}:${menit < 10 ? '0' + menit : menit}`;
}

function calcSunTimes(date, lat, lon) {
  try {
    const N = Math.floor((date - new Date(date.getFullYear(), 0, 0)) / 86400000);
    const lngHour = lon / 15;
    const t = N + 1; 
    const M = (0.9856 * t) - 3.289;
    let L = M + (1.916 * Math.sin(M * Math.PI / 180)) + (0.020 * Math.sin(2 * M * Math.PI / 180)) + 282.634;
    L = (L + 360) % 360;

    const RA = Math.atan(0.91764 * Math.tan(L * Math.PI / 180)) * 180 / Math.PI;
    const Lq = Math.floor(L / 90) * 90, RAq = Math.floor(RA / 90) * 90;
    const RAcor = (RA + (Lq - RAq)) / 15;

    const sinDec = 0.39782 * Math.sin(L * Math.PI / 180);
    const cosDec = Math.cos(Math.asin(sinDec));
    const cosH = (Math.cos(90.833 * Math.PI / 180) - (sinDec * Math.sin(lat * Math.PI / 180))) / (cosDec * Math.cos(lat * Math.PI / 180));

    if (cosH > 1 || cosH < -1) {
        return { sunrise: 6, sunset: 18 }; 
    }
    
    const H = Math.acos(cosH) * 180 / Math.PI; 
    const HhRise = (360 - H) / 15;
    const HhSet = H / 15;

    const TRise = HhRise + RAcor - (0.06571 * t) - 6.622;
    const TSet = HhSet + RAcor - (0.06571 * t) - 6.622;

    const UTRise = (TRise - lngHour + 24) % 24;
    const UTSet = (TSet - lngHour + 24) % 24;

    const tzOffset = date.getTimezoneOffset() / -60;
    return {
        sunrise: UTRise + tzOffset,
        sunset: UTSet + tzOffset
    };
  } catch (e) {
    console.error("Gagal menghitung sun times:", e);
    return { sunrise: 5.75, sunset: 17.75 }; 
  }
}

async function initFalak() {
  try {
    const pos = await new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        reject(new Error("Geolocation tidak didukung."));
      } else {
        navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 });
      }
    });
    lat = pos.coords.latitude;
    lon = pos.coords.longitude;
  } catch (err) {
    console.warn(`Gagal mendapatkan lokasi: ${err.message}. Menggunakan lokasi default (Bogor).`);
  }

  const now = new Date();
  const tomorrow = new Date(now.getTime() + 86400000);
  
  const todayTimes = calcSunTimes(now, lat, lon);
  const tomorrowTimes = calcSunTimes(tomorrow, lat, lon);

  sunriseTime = todayTimes.sunrise;
  sunsetTime = todayTimes.sunset;
  sunriseTomorrow = tomorrowTimes.sunrise;
  
  const totalMenitSiang = (sunsetTime - sunriseTime) * 60;
  const totalMenitMalam = ((24 - sunsetTime) + sunriseTomorrow) * 60;
  
  durasiJamSaatSiang = totalMenitSiang / 12;
  durasiJamSaatMalam = totalMenitMalam / 12;

  if(sunriseElem) sunriseElem.textContent = `setelah ${formatJam(sunriseTime)} (Lokal)`;
  if(saatInfoElem) saatInfoElem.textContent = `Durasi Jam Sa'at: ~${durasiJamSaatSiang.toFixed(0)} menit (Siang) / ~${durasiJamSaatMalam.toFixed(0)} menit (Malam)`;
  
  updateTime();
  setInterval(updateTime, 1000);
}

function getPenguasaHari(now) {
  const h = now.getHours() + now.getMinutes() / 60;
  let dayIndex = now.getDay(); 
  
  if (h < sunriseTime) {
    dayIndex = (dayIndex - 1 + 7) % 7;
  }
  return planetHari[dayIndex];
}

function getPlanetJam(now, penguasaHariIni) {
  const h = now.getHours() + now.getMinutes() / 60;
  
  const startIndex = chaldeanOrder.indexOf(penguasaHariIni);
  if (startIndex === -1) return "Error";

  let jamSaatIndex = 0;
  let planetJam = "";

  if (h >= sunriseTime && h < sunsetTime) {
    // Waktu Siang
    const menitSejakTerbit = (h - sunriseTime) * 60;
    jamSaatIndex = Math.floor(menitSejakTerbit / durasiJamSaatSiang); 
    if (jamSaatIndex > 11) jamSaatIndex = 11; 
    
    planetJam = chaldeanOrder[(startIndex + jamSaatIndex) % 7];
    
  } else {
    // Waktu Malam
    const startIndexMalam = (startIndex + 12) % 7;
    let menitSejakTerbenam;

    if (h >= sunsetTime) {
      menitSejakTerbenam = (h - sunsetTime) * 60;
    } else {
      menitSejakTerbenam = ((24 - sunsetTime) + h) * 60;
    }

    jamSaatIndex = Math.floor(menitSejakTerbenam / durasiJamSaatMalam); 
    if (jamSaatIndex > 11) jamSaatIndex = 11;
    
    planetJam = chaldeanOrder[(startIndexMalam + jamSaatIndex) % 7];
  }
  
  return planetJam;
}

function updateTime(){
  const d = new Date();
  
  const penguasaHariIni = getPenguasaHari(d);
  const planetJamIni = getPlanetJam(d, penguasaHariIni);
  
  if(hariElem) hariElem.textContent = penguasaHariIni;
  if(planetElem) planetElem.textContent = planetJamIni;
  if(jamElem) jamElem.textContent = d.toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});
  
  try {
    const hijriahFormatter = new Intl.DateTimeFormat('ar-SA-u-ca-islamic-nu-latn', {day: 'numeric', month: 'long', year: 'numeric'});
    if(hijriahElem) hijriahElem.textContent = "üìÖ " + hijriahFormatter.format(d);
  } catch (e) {
    if(hijriahElem) hijriahElem.textContent = "üìÖ (Gagal memuat tanggal Hijriah)";
  }
  
  // [MIND BLOWING] Menggunakan Tafsir Ijtima'
  if(tafsirElem) {
    tafsirElem.textContent = getTafsirIjtima(penguasaHariIni, planetJamIni);
  }
}

// ==================================================
// AKHIR DARI ROMBAKAN MESIN HISAB
// ==================================================

const canvas=document.getElementById("universe");
const ctx=canvas.getContext("2d");
let cx = innerWidth / 2;
let cy = innerHeight * 0.45; 

let mouse = { x: -9999, y: -9999 };
let hoveringPlanet = null;
const stardustCursor = document.getElementById('stardust-cursor');
const perspective = 0.4; 

const planetInfo = {
  "‚òâ Syams": {
    title: "‚òâ Syams (Matahari)",
    desc: "Energi Inti Ruh. Aspek: Kewibawaan, Kepemimpinan, Kemuliaan, Pusat Kekuatan Batin, Cahaya Ilahi. Tabiat: Panas & Kering. Logam: Emas."
  },
  "‚òø UtƒÅrid": {
    title: "‚òø UtƒÅrid (Merkurius)",
    desc: "Energi Akal & Komunikasi. Aspek: Kecerdasan, Ilmu, Penulisan, Perdagangan, Kefasihan Lidah, Perantara. Tabiat: Campuran (Netral). Logam: Air Raksa."
  },
  "‚ôÄ Zuhrah": {
    title: "‚ôÄ Zuhrah (Venus)",
    desc: "Energi Harmoni & Kasih. Aspek: Cinta, Keindahan, Seni, Kesenangan, Diplomasi, Penerimaan, Kesuburan. Tabiat: Dingin & Lembab. Logam: Tembaga."
  },
  "‚òæ Qamar": {
    title: "‚òæ Qamar (Bulan)",
    desc: "Energi Perasaan & Batin. Aspek: Intuisi, Kelembutan, Imajinasi, Perubahan, Hal-hal Tersembunyi, Koneksi Ruhani. Tabiat: Dingin & Lembab. Logam: Perak."
  },
  "‚ôÇ Marƒ´kh": {
    title: "‚ôÇ Marƒ´kh (Mars)",
    desc: "Energi Kekuatan & Ketegasan. Aspek: Keberanian, Energi Fisik, Ketajaman, Memutus Perkara, Proteksi, Kekuatan Tempur. Tabiat: Panas & Kering. Logam: Besi."
  },
  "‚ôÉ Musytarƒ´": {
    title: "‚ôÉ Musytarƒ´ (Jupiter)",
    desc: "Energi Kelimpahan & Keberuntungan. Aspek: Rezeki, Ekspansi, Ilmu Hikmah, Guru Spiritual, Keberkahan, Keadilan. Tabiat: Panas & Lembab. Logam: Timah."
  },
  "‚ôÑ Zuhal": {
    title: "‚ôÑ Zuhal (Saturnus)",
    desc: "Energi Struktur & Batasan. Aspek: Kesabaran, Fondasi, Disiplin, Penjagaan Gaib, tapi juga urusan keras: Halak (penghancuran), pemisah, & serangan balik. Tabiat: Dingin & Kering. Logam: Timbal."
  }
};

// [UPGRADE AJIB] Obyek baru untuk tafsir lahir (bug "tafsir tidak ditemukan")
const planetTafsirLahir = {
  "Syams": { 
    desc: "Energi Inti Ruh. Aspek: Kewibawaan, Kepemimpinan, Kemuliaan, Pusat Kekuatan Batin, Cahaya Ilahi.",
    petuah: "Petuah Anda: Pimpinlah. Energi Anda adalah Wibawa Inti. Jangan ragu mengambil tanggung jawab, takdir Anda adalah menjadi pusat perhatian."
  },
  "Qamar": { 
    desc: "Energi Perasaan & Batin. Aspek: Intuisi, Kelembutan, Imajinasi, Perubahan, Hal-hal Tersembunyi, Koneksi Ruhani.",
    petuah: "Petuah Anda: Percaya Intuisi. Energi Anda adalah Perasaan Halus. Gunakan kepekaan batin Anda untuk melihat yang tak terlihat. Hati Anda adalah kompas."
  },
  "Marƒ´kh": { 
    desc: "Energi Kekuatan & Ketegasan. Aspek: Keberanian, Energi Fisik, Ketajaman, Memutus Perkara, Proteksi, Kekuatan Tempur.",
    petuah: "Petuah Anda: Bertindak Tegas. Energi Anda adalah Kekuatan. Jangan ragu memutus perkara. Selesaikan apa yang Anda mulai dengan keberanian."
  },
  "UtƒÅrid": { 
    desc: "Energi Akal & Komunikasi. Aspek: Kecerdasan, Ilmu, Penulisan, Perdagangan, Kefasihan Lidah, Perantara.",
    petuah: "Petuah Anda: Berpikirlah. Energi Anda adalah Akal & Komunikasi. Gunakan kecerdasan lisan dan tulisan Anda. Ilmu adalah senjata Anda."
  },
  "Musytarƒ´": { 
    desc: "Energi Kelimpahan & Keberuntungan. Aspek: Rezeki, Ekspansi, Ilmu Hikmah, Guru Spiritual, Keberkahan, Keadilan.",
    petuah: "Petuah Anda: Sebarkan Berkah. Energi Anda adalah Keberuntungan. Jangan takut memulai hal besar. Rezeki Anda akan datang dari membantu orang lain."
  },
  "Zuhrah": { 
    desc: "Energi Harmoni & Kasih. Aspek: Cinta, Keindahan, Seni, Kesenangan, Diplomasi, Penerimaan, Kesuburan.",
    petuah: "Petuah Anda: Ciptakan Harmoni. Energi Anda adalah Kasih Sayang. Gunakan pesona Anda untuk mendamaikan. Hindari konflik, cari keindahan."
  },
  "Zuhal": { 
    desc: "Energi Struktur & Batasan. Aspek: Kesabaran, Fondasi, Disiplin, Penjagaan Gaib, tapi juga urusan keras: Halak, pemisah, & serangan balik.",
    petuah: "Petuah Anda: Bangun Fondasi. Energi Anda adalah Keteguhan. Jangan terburu-buru. Kesabaran dan disiplin adalah kunci Anda. Anda adalah pelindung."
  }
};


function resizeCanvas() {
    canvas.width=innerWidth;
    canvas.height=innerHeight;
    cx = canvas.width / 2;
    cy = canvas.height * 0.45; 
}
window.addEventListener('resize', () => {
  resizeCanvas();
  setDynamicViewportHeight(); 
});
resizeCanvas();

function makeStar(){return{x:(Math.random()*2-1)*canvas.width,y:(Math.random()*2-1)*canvas.height,z:Math.random()*canvas.width,o:Math.random(), vo: Math.random() * 0.05 - 0.025};}
const stars=Array(1200).fill().map(makeStar);

const planets=[
  {name:"‚òâ Syams",r:38,orbit:0,dist:0,color:"#FFD86C",speed:0.000, x:cx, y:cy, size:0, zPos: 0, hasRings: false}, 
  {name:"‚òø UtƒÅrid",r:22,orbit:90,dist:140,color:"#A68E74",speed:0.00017, x:0, y:0, size:0, zPos: 0, hasRings: false},
  {name:"‚ôÄ Zuhrah",r:28,orbit:120,dist:190,color:"#E8B888",speed:0.00014, x:0, y:0, size:0, zPos: 0, hasRings: false},
  {name:"‚òæ Qamar",r:24,orbit:230,dist:250,color:"#CDE3F3",speed:0.00012, x:0, y:0, size:0, zPos: 0, hasRings: false},
  {name:"‚ôÇ Marƒ´kh",r:36,orbit:310,dist:320,color:"#D67045",speed:0.0001, x:0, y:0, size:0, zPos: 0, hasRings: false},
  {name:"‚ôÉ Musytarƒ´",r:56,orbit:400,dist:400,color:"#E8CDA2",speed:0.00009, x:0, y:0, size:0, zPos: 0, hasRings: false},
  {name:"‚ôÑ Zuhal",r:52,orbit:480,dist:470,color:"#C5BA9D",speed:0.00008, x:0, y:0, size:0, zPos: 0, hasRings: true} 
];

function drawNebula(t) {
  ctx.save();
  ctx.globalAlpha = 0.04; 
  let timeFactor = t * 0.000005; 
  
  let neb1x = cx * 0.5 + Math.sin(timeFactor) * 100;
  let neb1y = cy * 0.7 + Math.cos(timeFactor) * 100;
  let nebula1 = ctx.createRadialGradient(neb1x, neb1y, 0, neb1x, neb1y, cx * 0.8);
  nebula1.addColorStop(0, 'rgba(80, 120, 255, 1)');
  nebula1.addColorStop(1, 'rgba(80, 120, 255, 0)');
  ctx.fillStyle = nebula1;
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  let neb2x = cx * 1.5 + Math.cos(timeFactor) * 100;
  let neb2y = cy * 1.2 + Math.sin(timeFactor) * 100;
  let nebula2 = ctx.createRadialGradient(neb2x, neb2y, 0, neb2x, neb2y, cx * 0.7);
  nebula2.addColorStop(0, 'rgba(150, 80, 255, 1)');
  nebula2.addColorStop(1, 'rgba(150, 80, 255, 0)');
  ctx.fillStyle = nebula2;
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  ctx.restore();
}

function drawPlanet(p,t){
  let scale = Math.min(cx, cy) / 500; 
  let orbitDistX = p.dist * scale;
  let orbitDistY = orbitDistX * perspective; 
  
  let angle = t * p.speed + p.orbit;
  let sinAngle = Math.sin(angle);
  p.zPos = sinAngle; 
  
  let zScale = 0.7 + (sinAngle * 0.3); 
  let planetSize = (p.r * Math.max(0.7, scale)) * zScale;
  
  let x = cx + (orbitDistX > 0 ? Math.cos(angle) * orbitDistX : 0);
  let y = cy + (orbitDistY > 0 ? sinAngle * orbitDistY : 0);
  
  p.x = x;
  p.y = y;
  p.size = planetSize;

  const isHovering = p === hoveringPlanet;
  const pulse = isHovering ? Math.sin(t * 0.003) * 3 : 0; 
  
  let ringRadiusX = planetSize * 2;
  let ringRadiusY = planetSize * perspective * 0.7;

  if (p.hasRings && p.zPos > 0) {
      ctx.save();
      ctx.beginPath();
      ctx.strokeStyle = 'rgba(200, 190, 170, 0.5)';
      ctx.lineWidth = planetSize * 0.3;
      ctx.ellipse(x, y, ringRadiusX, ringRadiusY, 0, Math.PI, Math.PI * 2); 
      ctx.stroke();
      ctx.restore();
  }

  if (p.name === "‚òâ Syams") {
    let glowGrad = ctx.createRadialGradient(x,y,planetSize * 1.2, x,y, planetSize * 3 + pulse);
    glowGrad.addColorStop(0, "rgba(255, 180, 80, 0.5)");
    glowGrad.addColorStop(0.7, "rgba(255, 100, 50, 0.2)");
    glowGrad.addColorStop(1, "rgba(255, 100, 50, 0)");
    ctx.beginPath();
    ctx.fillStyle = glowGrad;
    ctx.arc(x,y, planetSize * 3 + pulse, 0, Math.PI * 2);
    ctx.fill();
    
    let coreGrad = ctx.createRadialGradient(x,y,0, x,y, planetSize + pulse);
    coreGrad.addColorStop(0, "rgba(255, 255, 230, 1)");
    coreGrad.addColorStop(0.5, p.color);
    coreGrad.addColorStop(1, "rgba(220, 100, 0, 0.4)"); 
    ctx.beginPath();
    ctx.fillStyle = coreGrad;
    ctx.arc(x,y, planetSize + pulse,0,Math.PI*2);
    ctx.fill();
    
  } else {
    let sun = planets[0];
    let dx = sun.x - x;
    let dy = sun.y - y;
    let dist = Math.sqrt(dx*dx + dy*dy);
    let highlightX = x, highlightY = y;

    if (dist > 0) {
        let normX = dx / dist;
        let normY = dy / dist;
        highlightX = x + normX * planetSize * 0.4;
        highlightY = y + normY * planetSize * 0.4;
    }

    let grad=ctx.createRadialGradient(
      highlightX, 
      highlightY, 
      planetSize * 0.05, 
      x, y, planetSize + pulse 
    );
    grad.addColorStop(0, "rgba(255,255,255,0.7)");
    grad.addColorStop(0.4, p.color);
    grad.addColorStop(1, "rgba(0,0,0,0.4)");
    ctx.beginPath();ctx.fillStyle=grad;ctx.arc(x,y,planetSize + pulse,0,Math.PI*2);ctx.fill();
  }
  
  if (p.hasRings && p.zPos <= 0) {
      ctx.save();
      ctx.beginPath();
      ctx.strokeStyle = 'rgba(200, 190, 170, 0.7)';
      ctx.lineWidth = planetSize * 0.3;
      ctx.ellipse(x, y, ringRadiusX, ringRadiusY, 0, 0, Math.PI); 
      ctx.stroke();
      ctx.restore();
  }
  
  if (orbitDistX > 0) {
    ctx.beginPath();
    ctx.strokeStyle=`rgba(255,215,130,0.08)`;
    ctx.ellipse(cx, cy, orbitDistX, orbitDistY, 0, 0, Math.PI * 2);
    ctx.stroke();
  }
  
  ctx.font=`${14 * Math.max(0.8, scale) * zScale}px 'Cormorant Garamond'`; 
  ctx.fillStyle= isHovering ? "#FFD700" : "#e6dcb0"; 
  ctx.textAlign="center";
  ctx.shadowColor = isHovering ? "#FFD700" : "transparent";
  ctx.shadowBlur = isHovering ? 10 : 0;
  ctx.fillText(p.name,x,y-planetSize-8 - (isHovering ? pulse : 0));
  ctx.shadowBlur = 0; 
}

function animate(t){
  ctx.fillStyle="rgba(10,6,25,0.9)";
  ctx.fillRect(0,0,canvas.width,canvas.height);
  
  if(showPlanets) drawNebula(t); 

  if(showPlanets) {
      planets.forEach(p => {
          let scale = Math.min(cx, cy) / 500;
          let orbitDistX = p.dist * scale;
          let orbitDistY = orbitDistX * perspective;
          let angle = t * p.speed + p.orbit;
          let sinAngle = Math.sin(angle);
          
          p.zPos = sinAngle;
          p.x = cx + (orbitDistX > 0 ? Math.cos(angle) * orbitDistX : 0);
          p.y = cy + (orbitDistY > 0 ? sinAngle * orbitDistY : 0);
          
          let zScale = 0.7 + (sinAngle * 0.3);
          p.size = (p.r * Math.max(0.7, scale)) * zScale;
      });
  }

  let currentlyHovering = null;
  if(showPlanets) {
    planets.sort((a, b) => b.zPos - a.zPos); 
    
    for (const p of planets) {
      const clickZone = p.size * 1.1; 
      const dist = Math.sqrt(Math.pow(mouse.x - p.x, 2) + Math.pow(mouse.y - p.y, 2));
      if (dist < clickZone) {
        currentlyHovering = p;
        break; 
      }
    }
  }
  hoveringPlanet = currentlyHovering;

  if (stardustCursor) {
    stardustCursor.classList.toggle('hovering-planet', !!hoveringPlanet);
  }
  canvas.classList.toggle('interactive-planet', !!hoveringPlanet);

  stars.forEach(s=>{
    s.z-=1.5;
    if(s.z<=0){Object.assign(s,makeStar());s.z=canvas.width;}
    
    s.o += s.vo;
    if (s.o <= 0.1) { s.o = 0.1; s.vo *= -1; }
    if (s.o >= 0.9) { s.o = 0.9; s.vo *= -1; }
    
    const k=200/s.z;
    const px=s.x*k+cx;
    const py=s.y*k+cy;
    if(px>=0&&px<canvas.width&&py>=0&&py<canvas.height){
      ctx.fillStyle=`rgba(255,255,230,${s.o * (1 - s.z / canvas.width)})`;
      ctx.fillRect(px,py,1,1);
    }
  });
  
  if(showPlanets) {
    planets.sort((a, b) => a.zPos - b.zPos); 
    planets.forEach(p=>drawPlanet(p,t));
  }
  
  requestAnimationFrame(animate);
}
animate(0);


canvas.addEventListener('mousemove', e => {
    mouse.x = e.clientX;
    mouse.y = e.clientY;
});

canvas.addEventListener('click', e => {
  if (!showPlanets) return;

  const rect = canvas.getBoundingClientRect();
  const clickX = e.clientX - rect.left;
  const clickY = e.clientY - rect.top;

  let clickedPlanet = null;

  planets.sort((a, b) => b.zPos - a.zPos); 

  for (const p of planets) {
    const clickZone = p.size * 1.1; 
    const dist = Math.sqrt(Math.pow(clickX - p.x, 2) + Math.pow(clickY - p.y, 2));
    
    if (dist < clickZone) {
      clickedPlanet = p;
      break; 
    }
  }

  if (clickedPlanet) {
    const info = planetInfo[clickedPlanet.name];
    if (info) {
      openModal(info.title, `<p>${info.desc}</p>`);
    }
  }
});


const modalOverlay=document.createElement('div');
modalOverlay.id='modalOverlay';
modalOverlay.style=`position:fixed;top:0;left:0;width:100%;height:100%;
background:rgba(0,0,0,0.75);backdrop-filter:blur(4px);
display:none;justify-content:center;align-items:center;z-index:9998;opacity:0;transition:opacity 0.6s ease; pointer-events: auto;`; 
document.body.appendChild(modalOverlay);

const modalBox=document.createElement('div');
modalBox.style=`background:rgba(15,10,30,0.95);
border:1px solid gold;border-radius:18px;padding:25px 18px;max-width:340px;
color:#f6eabf;text-align:center;font-family:'Cormorant Garamond',serif;
box-shadow:0 0 25px rgba(255,215,130,0.3);animation:fadeIn 0.8s ease;overflow-y:auto;max-height:85vh;`;
modalOverlay.appendChild(modalBox);

modalBox.innerHTML=`<h3 id="modalTitle" style="font-family:'Cinzel Decorative',serif;color:#fcefb5;text-shadow:0 0 12px gold;margin-bottom:10px;">Judul</h3><div id="modalContent" style="font-size:1em;line-height:1.5;"></div><button id="modalCloseBtn" style="margin-top:15px;padding:6px 14px;border:1px solid #d6be74;background:rgba(255,255,255,0.05);border-radius:10px;color:#f3e3b2;">Tutup</button>`;

const modalTitle=document.getElementById('modalTitle');
const modalContent=document.getElementById('modalContent');
const chime=document.getElementById('chime');

function openModal(title,content){
  if(modalTitle) modalTitle.innerHTML=title;
  if(modalContent) modalContent.innerHTML=content;
  modalOverlay.style.display='flex';
  chime.currentTime=0;
  chime.play().catch(e => console.log("Chime play failed", e));
  setTimeout(()=>{modalOverlay.style.opacity='1';},10);
}
function closeModal(){
  modalOverlay.style.opacity='0';
  setTimeout(()=>{modalOverlay.style.display='none';},500);
}
document.getElementById('modalCloseBtn').onclick = closeModal;
modalOverlay.addEventListener('click',e=>{if(e.target===modalOverlay)closeModal();});

const buttonSet1 = document.getElementById('button-set-1');
const buttonSet2 = document.getElementById('button-set-2');

// [ROMBAKAN TOTAL v2] Logika Kalkulator Sa'at (Haqiqi)
function calculateSaat(planetName, hajat) {
  let jamListSiang = [];
  let jamListMalam = [];
  const penguasaHariIni = getPenguasaHari(new Date());
  const startIndex = chaldeanOrder.indexOf(penguasaHariIni);
  
  // Loop Siang
  for (let i = 0; i < 12; i++) {
    const planetSaatIni = chaldeanOrder[(startIndex + i) % 7];
    if (planetSaatIni === planetName) {
      const waktuMulai = sunriseTime + (i * durasiJamSaatSiang / 60);
      const waktuSelesai = sunriseTime + ((i + 1) * durasiJamSaatSiang / 60);
      jamListSiang.push(`Jam ${formatJam(waktuMulai)} - ${formatJam(waktuSelesai)} (Siang)`);
    }
  }

  // Loop Malam
  const startIndexMalam = (startIndex + 12) % 7;
  for (let i = 0; i < 12; i++) {
    const planetSaatIni = chaldeanOrder[(startIndexMalam + i) % 7];
    if (planetSaatIni === planetName) {
      const waktuMulai = sunsetTime + (i * durasiJamSaatMalam / 60);
      const waktuSelesai = sunsetTime + ((i + 1) * durasiJamSaatMalam / 60);
      jamListMalam.push(`Jam ${formatJam(waktuMulai)} - ${formatJam(waktuSelesai)} (Malam)`);
    }
  }
  
  let resultText = `
    <p>Hari ini (${penguasaHariIni}), jam terbaik untuk <b>${hajat} (${planetName})</b> adalah:</p>
    <div id="saat-calculator-result">
      ${jamListSiang.join('<br>')}
      <br>
      ${jamListMalam.join('<br>')}
    </div>
    <p style="font-size: 0.8em; font-style: italic; margin-top: 10px;">(Perhitungan Haqiqi berdasarkan waktu Terbit/Terbenam Matahari di lokasi Anda)</p>
  `;
  
  openModal("üîÆ Kalkulator Sa'at Haqiqi", resultText);
}

// [UPDATE ZUHAL] Deskripsi Zuhal diperbarui
const calculatorModalContent = `
  <p>Pilih hajat Anda. Kami akan carikan jam-planet yang selaras hari ini (Hisab Haqiqi).</p>
  <div id="saat-calculator-buttons">
    <button class="saat-btn" data-planet="Syams" data-hajat="Kewibawaan">Kewibawaan (Syams)</button>
    <button class="saat-btn" data-planet="Zuhrah" data-hajat="Kasih Sayang">Kasih Sayang (Zuhrah)</button>
    <button class="saat-btn" data-planet="Musytarƒ´" data-hajat="Rezeki">Rezeki (Musytarƒ´)</button>
    <button class="saat-btn" data-planet="UtƒÅrid" data-hajat="Ilmu & Komunikasi">Ilmu (UtƒÅrid)</button>
    <button class="saat-btn" data-planet="Marƒ´kh" data-hajat="Kekuatan">Kekuatan (Marƒ´kh)</button>
    <button class="saat-btn" data-planet="Zuhal" data-hajat="Halak & Penjagaan">Halak & Penjagaan (Zuhal)</button>
    <button class="saat-btn" data-planet="Qamar" data-hajat="Intuisi & Batin">Intuisi (Qamar)</button>
  </div>
`;

// [MIND BLOWING 1] Konten Modal Kalkulator Lahir
const birthModalContent = `
  <p>Masukkan tanggal lahir Anda untuk melihat Planet Lahir (Penguasa Hari Lahir) Anda.</p>
  <div id="birth-calculator">
    <input type="date" id="birth-date-input">
    <button id="calc-birth-btn">Hitung</button>
  </div>
  <div id="birth-result" style="display:none;"></div>
`;

function calculateBirthEnergy() {
  const input = document.getElementById('birth-date-input');
  const resultDiv = document.getElementById('birth-result');
  if (!input.value) {
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = `<p style="color: #ff8888;">Silakan masukkan tanggal lahir Anda.</p>`;
    return;
  }
  
  const birthDate = new Date(input.value + 'T12:00:00');
  const dayIndex = birthDate.getDay(); // 0=Minggu, 1=Senin...
  const hariLahir = ["Ahad (Minggu)", "Itsnain (Senin)", "Tsulatsa (Selasa)", "Arbi'a (Rabu)", "Khamis (Kamis)", "Jum'at", "Sabt (Sabtu)"][dayIndex];
  const planetLahir = planetHari[dayIndex];
  
  // [PERBAIKAN BUG] Menggunakan obyek planetTafsirLahir yang baru
  const tafsirData = planetTafsirLahir[planetLahir];
  const tafsir = tafsirData ? tafsirData.desc : "Tafsir tidak ditemukan.";
  const petuah = tafsirData ? tafsirData.petuah : "Petuah tidak ditemukan.";
  
  resultDiv.style.display = 'block';
  resultDiv.innerHTML = `
    <p><b>Hari Lahir Anda:</b> ${hariLahir}</p>
    <p><b>Planet Lahir Anda:</b> ${planetLahir}</p>
    <hr style="border-color: #d8c471; opacity: 0.3;">
    <p style="font-size: 0.9em;"><b>Tafsir Energi Dasar:</b><br>${tafsir}</p>
    <p class="petuah"><b>Petuah Penting:</b><br>${petuah}</p>
  `;
}

// [MIND BLOWING 2] Konten Kalkulator Arah Hajat
const arahHajatMap = {
  "Syams": { arah: "Timur (Masyriq)", hajat: "Kewibawaan, jabatan, menghadap penguasa." },
  "Qamar": { arah: "Utara (Syamal)", hajat: "Intuisi, rahasia, amalan batin, perjalanan air." },
  "Marƒ´kh": { arah: "Selatan (Janub)", hajat: "Kekuatan, keberanian, mengalahkan musuh, perang." },
  "UtƒÅrid": { arah: "Barat Laut", hajat: "Ilmu, kecerdasan, perdagangan, surat-menyurat." },
  "Musytarƒ´": { arah: "Barat (Maghrib)", hajat: "Rezeki, keberuntungan, memulai usaha, keadilan." },
  "Zuhrah": { arah: "Timur Laut", hajat: "Cinta (Mahabbah), harmoni, kesenian, perdamaian." },
  "Zuhal": { arah: "Tenggara", hajat: "Urusan keras (Halak, Tafriq), penjagaan, urusan tanah/properti." }
};

function calculateArahHajat() {
  const hariIni = getPenguasaHari(new Date());
  const info = arahHajatMap[hariIni];
  let resultText = `
    <div id="direction-result">
      <p>Hari ini adalah Hari <b>${hariIni}</b>.</p>
      <p>Arah Hajat (Qiblat al-Hajat) yang mustajab hari ini adalah:</p>
      <h2 style="font-family:'Cinzel Decorative',serif; color:#aae0ff; margin: 10px 0;">${info.arah}</h2>
      <p style="font-size: 0.95em; color: #f0e6b2;">Arah ini sangat baik untuk berdoa, ritual, atau memulai hajat yang bersifat: <b>${info.hajat}</b></p>
    </div>
  `;
  openModal("üß≠ Arah Hajat Mustajab", resultText);
}

// [MIND BLOWING 3] Logika Hisab Nama (Abjad)
// Peta Abjad Hawwaz
const abjadHawwaz = {
    'A': 1, 'B': 2, 'C': 3, 'D': 4, 'E': 5, 'F': 80, 'G': 3, 'H': 5, 'I': 10,
    'J': 3, 'K': 20, 'L': 30, 'M': 40, 'N': 50, 'O': 70, 'P': 80, 'Q': 100, 'R': 200,
    'S': 60, 'T': 9, 'U': 6, 'V': 6, 'W': 6, 'X': 60, 'Y': 10, 'Z': 7
};

// [UPGRADE AJIB] Tafsir Angka Dasar
const tafsirAngkaDasar = {
  1: {
    nama: "1 (Matahari/Syams)",
    desc: "Energi Awal, Kepemimpinan, Ego, dan Individualitas.",
    petuah: "Petuah Anda: Anda adalah Pemimpin. Energi Anda kuat dan mandiri. Jangan hanya mengikuti, tapi ciptakan jalan Anda sendiri. Hati-hati dengan ego yang terlalu tinggi."
  },
  2: {
    nama: "2 (Bulan/Qamar)",
    desc: "Energi Keseimbangan, Intuisi, Diplomasi, dan Perasaan.",
    petuah: "Petuah Anda: Anda adalah Diplomat. Energi Anda sensitif dan penuh intuisi. Gunakan kelembutan Anda untuk mendamaikan, jangan terhanyut dalam dualitas keraguan."
  },
  3: {
    nama: "3 (Jupiter/Musytarƒ´)",
    desc: "Energi Ekspansi, Kreativitas, Komunikasi, dan Keberuntungan.",
    petuah: "Petuah Anda: Anda adalah Kreator. Energi Anda ekspansif dan sosial. Gunakan kreativitas dan kemampuan komunikasi Anda untuk menyebarkan kebahagiaan dan menarik rezeki."
  },
  4: {
    nama: "4 (Saturnus/Zuhal)",
    desc: "Energi Struktur, Fondasi, Kerja Keras, dan Batasan.",
    petuah: "Petuah Anda: Anda adalah Pembangun. Energi Anda stabil dan terstruktur. Kesabaran dan disiplin adalah kunci Anda. Bangun fondasi yang kuat, jangan takut kerja keras."
  },
  5: {
    nama: "5 (Merkurius/UtƒÅrid)",
    desc: "Energi Perubahan, Kebebasan, Kecerdasan, dan Petualangan.",
    petuah: "Petuah Anda: Anda adalah Petualang. Energi Anda dinamis dan cerdas. Anda butuh kebebasan dan perubahan. Gunakan kecerdasan Anda untuk beradaptasi."
  },
  6: {
    nama: "6 (Venus/Zuhrah)",
    desc: "Energi Harmoni, Cinta, Keluarga, dan Tanggung Jawab.",
    petuah: "Petuah Anda: Anda adalah Perawat. Energi Anda penuh cinta dan harmoni. Fokus Anda adalah keluarga dan komunitas. Ciptakan keindahan dan kedamaian."
  },
  7: {
    nama: "7 (Bulan/Qamar)",
    desc: "Energi Spiritual, Analisis, Misteri, dan Pengetahuan Batin.",
    petuah: "Petuah Anda: Anda adalah Pertapa. Energi Anda spiritual dan analitis. Anda butuh waktu menyendiri untuk merenung. Cari kebenaran dan pengetahuan batin."
  },
  8: {
    nama: "8 (Mars/Marƒ´kh)",
    desc: "Energi Kekuatan, Kekuasaan, Materi, dan Karma.",
    petuah: "Petuah Anda: Anda adalah Eksekutor. Energi Anda kuat dan material. Anda punya kekuatan untuk sukses besar di dunia materi, tapi hati-hati dengan karma. Gunakan kekuatan dengan bijak."
  },
  9: {
    nama: "9 (Mars/Marƒ´kh)",
    desc: "Energi Penyelesaian, Kemanusiaan, dan Transformasi.",
    petuah: "Petuah Anda: Anda adalah Humanis. Energi Anda universal. Anda di sini untuk menyelesaikan siklus dan membantu banyak orang. Lepaskan masa lalu, fokus pada gambaran besar."
  }
};

function getAngkaDasar(n) {
  let sum = n;
  while (sum > 9) {
    sum = sum.toString().split('').reduce((acc, digit) => acc + parseInt(digit), 0);
  }
  return sum;
}

function calculateAbjad() {
  const input = document.getElementById('abjad-name-input');
  const resultDiv = document.getElementById('abjad-result');
  const name = input.value.toUpperCase().replace(/[^A-Z]/g, ''); 
  
  if (!name) {
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = `<p style="color: #ff8888;">Silakan masukkan nama.</p>`;
    return;
  }
  
  let total = 0;
  for (let char of name) {
    total += abjadHawwaz[char] || 0;
  }
  
  const angkaDasar = getAngkaDasar(total);
  const tafsir = tafsirAngkaDasar[angkaDasar];
  
  resultDiv.style.display = 'block';
  resultDiv.innerHTML = `
    <p><b>Nama Dianalisis:</b> ${name}</p>
    <p><b>Nilai Hisab (Abjad):</b> ${total}</p>
    <p><b>Angka Dasar (Nasib):</b> ${angkaDasar} (${tafsir.nama})</p>
    <hr style="border-color: #d8c471; opacity: 0.3;">
    <p style="font-size: 0.9em;"><b>Tafsir Angka Dasar:</b><br>${tafsir.desc}</p>
    <p class="petuah"><b>Petuah Penting:</b><br>${tafsir.petuah}</p>
  `;
}

const abjadModalContent = `
  <p>Masukkan nama (Arab/Latin) untuk dihitung nilai Abjad (Hisab al-Jumal) nya.</p>
  <div id="abjad-calculator">
    <input type="text" id="abjad-name-input" placeholder="Masukkan Nama...">
    <button id="calc-abjad-btn">Hitung</button>
  </div>
  <div id="abjad-result" style="display:none;"></div>
`;

// [BARU] Logika Hisab Jodoh
const jodohModalContent = `
  <p>Masukkan data Anda dan pasangan untuk melihat tafsir kecocokan (Watak & Nasib).</p>
  <div id="jodoh-calculator">
    <div class="jodoh-group">
      <h4>Pihak 1 (Anda)</h4>
      <input type="text" id="jodoh-nama-1" class="jodoh-input" placeholder="Nama Lengkap Anda...">
      <input type="date" id="jodoh-tgl-1" class="jodoh-input">
    </div>
    <div class="jodoh-group">
      <h4>Pihak 2 (Pasangan)</h4>
      <input type="text" id="jodoh-nama-2" class="jodoh-input" placeholder="Nama Lengkap Pasangan...">
      <input type="date" id="jodoh-tgl-2" class="jodoh-input">
    </div>
    <button id="calc-jodoh-btn">Hitung Kecocokan</button>
  </div>
  <div id="jodoh-result" style="display:none;"></div>
`;

function getPlanetLahir(tgl) {
  const birthDate = new Date(tgl + 'T12:00:00');
  const dayIndex = birthDate.getDay();
  return planetHari[dayIndex];
}
function getAngkaLahir(nama) {
  const name = nama.toUpperCase().replace(/[^A-Z]/g, '');
  let total = 0;
  for (let char of name) {
    total += abjadHawwaz[char] || 0;
  }
  return getAngkaDasar(total);
}
function getTafsirWatak(planet1, planet2) {
  return ijtimaTafsir[planet1][planet2];
}
function getTafsirNasib(angka1, angka2) {
  // Ini tafsir dasar, tafsir AI akan lebih dalam
  const total = getAngkaDasar(angka1 + angka2);
  return `Angka ${angka1} bertemu Angka ${angka2}. Menghasilkan Angka Gabungan <b>${total} (${tafsirAngkaDasar[total].nama})</b>. ${tafsirAngkaDasar[total].petuah}`;
}

function calculateJodoh() {
  const nama1 = document.getElementById('jodoh-nama-1').value;
  const tgl1 = document.getElementById('jodoh-tgl-1').value;
  const nama2 = document.getElementById('jodoh-nama-2').value;
  const tgl2 = document.getElementById('jodoh-tgl-2').value;
  const resultDiv = document.getElementById('jodoh-result');
  
  if (!nama1 || !tgl1 || !nama2 || !tgl2) {
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = `<p style="color: #ff8888;">Silakan isi semua 4 data.</p>`;
    return;
  }

  const planet1 = getPlanetLahir(tgl1);
  const angka1 = getAngkaLahir(nama1);
  const planet2 = getPlanetLahir(tgl2);
  const angka2 = getAngkaLahir(nama2);
  
  const tafsirWatak = getTafsirWatak(planet1, planet2);
  const tafsirNasib = getTafsirNasib(angka1, angka2);

  resultDiv.style.display = 'block';
  resultDiv.innerHTML = `
    <p><b>Pihak 1:</b> ${planet1} (Watak) & Angka ${angka1} (Nasib)</p>
    <p><b>Pihak 2:</b> ${planet2} (Watak) & Angka ${angka2} (Nasib)</p>
    <hr style="border-color: #d8c471; opacity: 0.3;">
    <h5>1. Tafsir Watak (Planet vs Planet)</h5>
    <p style="font-size: 0.9em;">${tafsirWatak}</p>
    <h5>2. Tafsir Nasib (Angka vs Angka)</h5>
    <p style="font-size: 0.9em;">${tafsirNasib}</p>
    <hr style="border-color: #d8c471; opacity: 0.3;">
    <p class="petuah"><b>Petuah Final (Dasar):</b><br>Tafsir di atas adalah gambaran dasar. Untuk tafsir lebih mendalam yang memperhitungkan nama lengkap dan energi Ijtima' Anda, silakan klik di bawah.</p>
    
    <button id="ai-jodoh-btn" class="ai-btn" style="width: 100%; margin: 10px 0;">‚ú® Minta Tafsir Mendalam</button>
    <div id="ai-jodoh-result"></div>
  `;
  
  document.getElementById('ai-jodoh-btn').onclick = () => {
    callGeminiJodoh(nama1, planet1, angka1, nama2, planet2, angka2);
  };
}

// [BARU] Logika Doa Hajat
const doaModalContent = `
  <p>Tuliskan hajat Anda (singkat & jelas). Mesin falak akan membantu merangkai do'a yang selaras dengan energi waktu saat ini.</p>
  <div id="doa-calculator">
    <input type="text" id="doa-hajat-input" placeholder="Contoh: Minta kelancaran rezeki dan arti do'a ...">
    <button id="calc-doa-btn">Buat Do'a</button>
  </div>
  <div id="doa-result" style="display:none;"></div>
`;

function calculateDoa() {
  const input = document.getElementById('doa-hajat-input').value;
  const resultDiv = document.getElementById('doa-result');
  const hariIni = getPenguasaHari(new Date());
  const planetJamIni = getPlanetJam(new Date(), hariIni); // Dapatkan Planet Jam
  
  if (!input) {
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = `<p style="color: #ff8888; direction: ltr; text-align: left;">Silakan tulis hajat Anda.</p>`;
    return;
  }
  
  resultDiv.style.display = 'block';
  resultDiv.innerHTML = `<div class="loader"></div>`; // Tampilkan loader
  
  const prompt = `
    Anda adalah seorang ahli Ilmu Hikmah dan Falaqiyah. 
    Hari ini adalah Hari ${hariIni}.
    Jam ini adalah Jam ${planetJamIni}.
    
    Tugas Anda: Buatkan satu do'a dalam bahasa Arab yang fasih (lengkap dengan harakat) untuk hajat berikut: "${input}". 
    
    PENTING:
    1. Do'a HARUS menggabungkan Asma'/Sifat Allah yang selaras dengan energi Hari ${hariIni} dan Jam ${planetJamIni}.
    2. Awali do'a dengan Basmallah dan Sholawat.
    3. Buat do'a-nya indah, puitis, dan khusyuk.
    4. JANGAN TAMBAHKAN TULISAN LATIN ATAU PENJELASAN APAPUN.
    5. Berikan HANYA teks Arab-nya saja.
  `;
  
  callGemini(prompt, resultDiv);
}

// [BARU] Logika Pertanyaan Falak (Q&A)
function calculateFalakQA() {
    const inputElement = document.getElementById('falak-question-input');
    const question = inputElement.value;
    const resultElement = document.getElementById('falak-result');
    
    if (!question) {
        resultElement.style.display = 'block';
        resultElement.innerHTML = `<p style="color: #ff8888; text-align: center;">Mohon tulis pertanyaan Anda, Guru.</p>`;
        return;
    }
    
    // Tampilkan loader dan bersihkan hasil sebelumnya
    resultElement.style.display = 'block';
    resultElement.innerHTML = `<div class="loader"></div>`;
    
    const hariIni = getPenguasaHari(new Date());
    const planetJamIni = getPlanetJam(new Date(), hariIni);
    const tafsirSaatIni = getTafsirIjtima(hariIni, planetJamIni);
    
    const prompt = `
        Anda adalah asisten AI yang bertindak sebagai Guru Besar Ilmu Falaqiyah dan Hikmah.
        
        Konteks Waktu Saat Ini:
        - Hari Penguasa: ${hariIni}
        - Planet Jam Aktif: ${planetJamIni}
        - Tafsir Energi Saat Ini: ${tafsirSaatIni}
        
        Tugas: Jawab pertanyaan berikut dengan bahasa Indonesia yang santun, puitis, dan kental dengan nuansa Hikmah/Falaqiyah.
        1. Jawab pertanyaan berdasarkan ilmu Falakiyah (astronomi/numerologi) atau tafsir energi (seperti ijtima' planet).
        2. Masukkan referensi ke Hari Penguasa dan Planet Jam saat ini dalam jawaban Anda.
        3. JANGAN berikan jawaban yang bersifat prediksi masa depan (ramalan) atau diagnosis medis.
        
        Pertanyaan Murid: "${question}"
    `;
    
    callGeminiFalak(prompt, resultElement);
}


// ==================================================
// [PERBAIKAN BUG] MESIN GEMINI API (Anti Gagal)
// ==================================================

const API_KEY = "AIzaSyDsVs8DFaNqdfDBiUJWLliHzxg_3fmsGLg"
const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;

// [PERBAIKAN] Fungsi Fetch dengan Exponential Backoff
async function fetchWithBackoff(apiUrl, payload, retries = 3, delay = 1000) {
  for (let i = 0; i < retries; i++) {
    try {
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (response.ok) {
        return await response.json();
      }
      // Jangan retry untuk bad request (4xx)
      if (response.status >= 400 && response.status < 500) {
        throw new Error(`Client Error: ${response.status}`);
      }
      // Retry untuk server errors (5xx) or throttling (429)
    } catch (error) {
      if (i === retries - 1) throw error; // Gagal terakhir, lempar error
    }
    // Tunggu sebelum retry
    await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
  }
}

// [PERBAIKAN] Fungsi panggil Gemini untuk Do'a
async function callGemini(prompt, resultElement) {
  const payload = {
    contents: [{ parts: [{ text: prompt }] }],
    safetySettings: [
        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
    ]
  };
  
  try {
    const result = await fetchWithBackoff(API_URL, payload);
    const text = result.candidates[0].content.parts[0].text;
    resultElement.innerHTML = text.replace(/\n/g, '<br>'); // Tampilkan doa
  } catch (error) {
    console.error("Gemini API Gagal:", error);
    resultElement.innerHTML = `<p style="color: #ff8888; direction: ltr; text-align: center;">Gagal memuat do'a. Coba lagi nanti.</p>`;
  }
}

// [PERBAIKAN] Fungsi panggil Gemini untuk Jodoh (JSON)
async function callGeminiJodoh(nama1, planet1, angka1, nama2, planet2, angka2) {
  const resultElement = document.getElementById('ai-jodoh-result');
  resultElement.innerHTML = `<div class="loader"></div>`;
  
  const systemPrompt = `Anda adalah ahli Hisab Jodoh Falaqiyah. Analisis 2 pasangan berikut. Berikan 1 paragraf tafsir watak (planet vs planet), 1 paragraf tafsir nasib (angka vs angka), dan 1 paragraf petuah final. Gunakan bahasa Indonesia  mistis tapi tidak puitis, tidak lebay dan tidak berlebihan, menjawab kecocokan pasangan, memberikan solusi terbaik.`;
  const userQuery = `Pihak 1: ${nama1} (Planet ${planet1}, Angka ${angka1}). Pihak 2: ${nama2} (Planet ${planet2}, Angka ${angka2}).`;

  const payload = {
    contents: [{ parts: [{ text: userQuery }] }],
    systemInstruction: { parts: [{ text: systemPrompt }] },
    generationConfig: {
      responseMimeType: "application/json",
      responseSchema: {
        type: "OBJECT",
        properties: {
          "tafsir_watak": { "type": "STRING" },
          "tafsir_nasib": { "type": "STRING" },
          "petuah_final": { "type": "STRING" }
        },
        required: ["tafsir_watak", "tafsir_nasib", "petuah_final"]
      }
    },
    safetySettings: [
        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
    ]
  };

  try {
    const result = await fetchWithBackoff(API_URL, payload);
    const jsonText = result.candidates[0].content.parts[0].text;
    const tafsir = JSON.parse(jsonText);
    
    resultElement.innerHTML = `
      <hr style="border-color: #ffb8d0; opacity: 0.3;">
      <h5 style="color: #ffcee0;">Tafsir Mendalam</h5>
      <p style="font-size: 0.9em;"><b>Watak (Planet):</b> ${tafsir.tafsir_watak}</p>
      <p style="font-size: 0.9em;"><b>Nasib (Angka):</b> ${tafsir.tafsir_nasib}</p>
      <p class="petuah" style="color: #ffcee0; border-top-color: #ffb8d0;"><b>Petuah Final:</b><br>${tafsir.petuah_final}</p>
    `;
    document.getElementById('ai-jodoh-btn').style.display = 'none'; // Sembunyikan tombol setelah berhasil
  } catch (error) {
    console.error("Gemini Jodoh API Gagal:", error);
    resultElement.innerHTML = `<p style="color: #ff8888; text-align: center;">Gagal memuat tafsir mendalam. Coba lagi nanti.</p>`;
  }
}

// [BARU] Fungsi panggil Gemini untuk Q&A Falak
async function callGeminiFalak(prompt, resultElement) {
  const payload = {
    contents: [{ parts: [{ text: prompt }] }],
    safetySettings: [
        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
    ]
  };
  
  try {
    const result = await fetchWithBackoff(API_URL, payload);
    const text = result.candidates[0].content.parts[0].text;
    resultElement.innerHTML = `<p>${text.replace(/\n/g, '<br>')}</p>`; // Tampilkan jawaban
  } catch (error) {
    console.error("Gemini Falak Q&A API Gagal:", error);
    resultElement.innerHTML = `<p style="color: #ff8888; text-align: center;">Maaf Guru, tabir langit sedang tertutup. Coba lagi nanti.</p>`;
  }
}

// ==================================================
// AKHIR DARI MESIN GEMINI API
// ==================================================


document.querySelectorAll('button').forEach(btn=>{
  btn.addEventListener('click',()=>{
    if(btn.id === 'audioBtn' || btn.id === 'unlock-btn' || btn.id === 'modalCloseBtn') return;
    
    // [BARU] Event untuk tombol Q&A Falak
    if(btn.id === 'ask-falak-btn') {
        calculateFalakQA();
        return;
    }
    
    if (btn.classList.contains('saat-btn')) {
      calculateSaat(btn.dataset.planet, btn.dataset.hajat);
      return;
    }

    switch(btn.textContent.trim()){
      case 'Amalan Lanjutan ‚ùØ':
        buttonSet1.classList.remove('button-set');
        buttonSet1.classList.add('button-set-inactive');
        document.querySelector('.calculator-button').style.display = 'none'; 
        document.querySelectorAll('.feature-btn-set').forEach(el => el.style.display = 'none'); // Sembunyikan fitur
        document.getElementById('new-ai-container').style.display = 'none'; // Sembunyikan Q&A
        buttonSet2.classList.remove('button-set-inactive');
        buttonSet2.classList.add('button-set');
        return;
      case '‚ùÆ Halaman Utama':
        buttonSet2.classList.remove('button-set');
        buttonSet2.classList.add('button-set-inactive');
        buttonSet1.classList.remove('button-set-inactive');
        buttonSet1.classList.add('button-set');
        document.querySelector('.calculator-button').style.display = 'block'; 
        document.querySelectorAll('.feature-btn-set').forEach(el => el.style.display = 'flex'); // Tampilkan fitur
        document.getElementById('new-ai-container').style.display = 'flex'; // Tampilkan Q&A
        return;
      case 'üîÆ Kalkulator Sa\'at':
        openModal("üîÆ Kalkulator Sa'at", calculatorModalContent);
        document.querySelectorAll('.saat-btn').forEach(saatBtn => {
          saatBtn.onclick = () => {
            calculateSaat(saatBtn.dataset.planet, saatBtn.dataset.hajat);
          };
        });
        return; 
      // [MIND BLOWING 1] Event Kalkulator Lahir
      case 'üåü Kalkulator Energi Lahir':
        openModal('üåü Kalkulator Energi Lahir', birthModalContent);
        document.getElementById('calc-birth-btn').onclick = calculateBirthEnergy;
        return;
      // [MIND BLOWING 2] Event Arah Hajat
      case 'üß≠ Kalkulator Arah Hajat':
        calculateArahHajat();
        return;
      // [MIND BLOWING 3] Event Hisab Nama
      case 'üî¢ Hisab Nama (Abjad)':
        openModal('üî¢ Hisab Nama (Abjad)', abjadModalContent);
        document.getElementById('calc-abjad-btn').onclick = calculateAbjad;
        return;
      // [MIND BLOWING 4] Event Hisab Jodoh
      case 'üíò Hisab Jodoh':
        openModal('üíò Hisab Jodoh', jodohModalContent);
        document.getElementById('calc-jodoh-btn').onclick = calculateJodoh;
        return;
      // [MIND BLOWING 5] Event Do'a Hajat
      case '‚ú® Buat Do\'a Hajat':
        openModal('‚ú® Buat Do\'a Hajat Khusus', doaModalContent);
        document.getElementById('calc-doa-btn').onclick = calculateDoa;
        return;
    }

    const waIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#25D366" viewBox="0 0 16 16" style="vertical-align: -0.125em; margin-right: 5px;"><path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/></svg>`;
    const waLinkEl = `<a href="https://wa.me/6285173262649" target="_blank" style="color: #fcefb5; font-weight: bold; text-decoration: underline; cursor: pointer; display: inline-flex; align-items: center; justify-content: center;">${waIcon}Endry Arya (WhatsApp)</a>`;
    
    const contactBlock = `
      <hr>
      <p style="margin-bottom: 5px;"><b>Untuk informasi lengkap:</b></p>
      <p style="font-size: 0.9em; font-style: italic; color: #d3b96f; margin-top: 0; margin-bottom: 10px;">(Klik logo WhatsApp di bawah untuk menghubungi kami)</p>
      <p style="margin-top: 10px;">${waLinkEl}</p>
    `;

    switch(btn.textContent.trim()){
      // Halaman 1
      case 'üïØ Sa‚Äôat Amal':
        openModal('üïØ Sa‚Äòat Amal',`
        <p>Setiap jam memiliki planet yang berkuasa atasnya. Lakukan amalan yang seirama dengan planet penguasanya, agar energi waktu berpadu dengan niat dan amalmu.</p>
        <p>üåû <b>Syams</b> ‚Äî kewibawaan & kemuliaan<br>üåô <b>Qamar</b> ‚Äî kelembutan & penerangan batin<br>‚òø <b>UtƒÅrid</b> ‚Äî kecerdasan & komunikasi<br>‚ôÄ <b>Zuhrah</b> ‚Äî kasih sayang & harmoni<br>‚ôÇ <b>Marƒ´kh</b> ‚Äî ketegasan & kekuatan<br>‚ôÉ <b>Musytarƒ´</b> ‚Äî rezeki & keberuntungan<br>‚ôÑ <b>Zuhal</b> ‚Äî penjagaan, halak, pemisah</p>
        <p><i>‚ÄúBarang siapa beramal pada sa‚Äòatnya, ia menyentuh getaran semesta.‚Äù</i></p>
        ${contactBlock}
        `);break;
      case 'üå† Waktu Mustajab':
        openModal('üå† Waktu Mustajab',`
        <p>Waktu mustajab adalah jam-planet (Sa'at) yang selaras dengan tabiat amalanmu. Gunakan "Kalkulator Sa'at" untuk menemukan jam yang tepat hari ini.</p>
        <p><i>‚ÄúAda saat di mana tabir langit menipis, dan doa naik tanpa penghalang.‚Äù</i></p>
        ${contactBlock}
        `);break;
      case 'üïä Do‚Äôa & Niat':
        openModal('üïä Do‚Äòa & Niat',`
        <p><b>Do‚Äòa Tahsin CBA</b></p>
        <p style="font-size: 1.2em; line-height: 1.8; direction: rtl; text-align: right;">ÿßŸÑŸÑŸëŸ∞ŸáŸèŸÖŸéŸë ÿßÿ¨ŸíÿπŸéŸÑŸíŸÜŸêŸä ŸÖŸêŸÜŸé ÿßŸÑŸéŸëÿ∞ŸêŸäŸÜŸé ŸÜŸéÿ∏Ÿéÿ±Ÿíÿ™Ÿé ÿ•ŸêŸÑŸéŸäŸíŸáŸêŸÖŸí ÿ®ŸêŸÜŸéÿ∏Ÿéÿ±Ÿéÿ©Ÿê ÿßŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéÿ©Ÿêÿå ŸàŸéŸÅŸéÿ™Ÿéÿ≠Ÿíÿ™Ÿé ŸÑŸéŸáŸèŸÖŸí ÿ£Ÿéÿ®ŸíŸàŸéÿßÿ®Ÿé ÿßŸÑŸíÿ≠ŸêŸÉŸíŸÖŸéÿ©Ÿêÿå ŸàŸéÿµŸéÿ±ŸéŸÅŸíÿ™Ÿé ÿπŸéŸÜŸíŸáŸèŸÖŸè ÿßŸÑŸíŸÅŸêÿ™ŸíŸÜŸéÿ©Ÿé.</p>
        <p><i>‚ÄúYa Allah, jadikan aku termasuk hamba yang Engkau pandang dengan rahmat-Mu, Engkau bukakan baginya pintu hikmah, dan Engkau jauhkan dari fitnah.‚Äù</i></p>
        ${contactBlock}
        `);break;
      case 'üìú Info Falakiyah':
        openModal('üìú Info Falakiyah',`
        <p>Ilmu Falakiyah menyingkap hubungan antara langit, waktu, dan ruh manusia. Website ini menggunakan metode Hisab Haqiqi (perhitungan akurat terbit/terbenam matahari lokal) untuk menentukan Jam Sa'at planet.</p>
        ${contactBlock}
        `);break;
      case 'ü™∂ Perhitungan Falaqiyah':
        openModal('ü™∂ Perhitungan Falaqiyah',`
        <p>Perhitungan Falaqiyah CBA membantu menentukan waktu terbaik untuk segala urusan ruhani & duniawi:</p>
        <p>üîπ Ritual Pelet<br>üîπ Halak & Pembinasaan<br>üîπ Pengobatan Ruhani<br>üîπ Rezeki & Keberuntungan<br>üîπ Pembuka Hijab & Perlindungan</p>
        ${contactBlock}
        `);break;
      
      // Halaman 2
      case 'üóù Ritual Khusus':
        openModal('üóù Ritual Khusus',`
        <p>Layanan ini mencakup panduan dan pelaksanaan ritual khusus yang disesuaikan dengan hajat Anda, menggunakan waktu dan sa'at falakiyah yang paling tajam.</p>
        <p><i>Hanya untuk anggota terverifikasi atau dengan bimbingan khusus.</i></p>
        ${contactBlock}
        `);break;
      case '‚ú® Asma\' Falakiyah':
        openModal('‚ú® Asma\' Falakiyah',`
        <p>Pembelajaran dan ijazah Asma' (Nama-nama) yang selaras dengan energi 7 planet (Kawakib). Digunakan untuk membangkitkan energi spiritual spesifik dalam diri.</p>
        <p><i>Membutuhkan bimbingan khusus untuk pengamalan.</i></p>
        ${contactBlock}
        `);break;
      case 'üìú Wafaq & Rajah':
        openModal('üìú Wafaq & Rajah',`
        <p>Layanan pembuatan Wafaq (jimat numerologi) dan Rajah (sigil) yang ditulis pada waktu falakiyah yang tepat, di atas media yang tepat, untuk hajat spesifik (kerezekian, proteksi, mahabbah).</p>
        ${contactBlock}
        `);break;
      case 'üí¨ Konsultasi Batin':
        openModal('üí¨ Konsultasi Batin',`
        <p>Konsultasi ruhani privat dengan Endry Arya untuk membaca energi, masalah, dan menentukan solusi terbaik menggunakan pendekatan falakiyah dan hikmah.</p>
        ${contactBlock}
        `);break;
    }
  });
});

// [PERBAIKAN] Counter dipisah agar tidak memblokir initFalak
async function loadVisitorCount() {
  try{
    const el=document.getElementById("visitor-count");
    if (!el) return;
    const r=await fetch("https://api.countapi.xyz/hit/langitfalaqyahcba/v4-ruh"); // Endpoint baru
    const data=await r.json();
    const total=data.value;
    el.textContent=total.toLocaleString("id-ID");
    
    if(total===1){
      // ... (sigil code) ...
    }
  }catch(e){
    console.log("Pelacak ruh gagal:",e);
    const el=document.getElementById("visitor-count");
    if(el) el.textContent = '‚ú¶'; 
  }
}

window.addEventListener('load',async()=>{
  // Jalankan keduanya secara paralel
  initFalak(); 
  loadVisitorCount();
});

const stardustCursorEl = document.getElementById('stardust-cursor');
if (stardustCursorEl) {
  window.addEventListener('mousemove', e => {
    stardustCursorEl.style.left = e.clientX + 'px';
    stardustCursorEl.style.top = e.clientY + 'px';
  });
  document.body.addEventListener('mouseleave', () => {
     stardustCursorEl.style.opacity = '0';
  });
  document.body.addEventListener('mouseenter', () => {
     stardustCursorEl.style.opacity = '1';
  });
}

</script>

<style>
@keyframes sigilRise{
  0%{opacity:0;transform:scale(.5)rotate(0deg);}
  10%{opacity:1;transform:scale(1.2)rotate(72deg);}
  40%{opacity:1;transform:scale(1)rotate(144deg);}
  70%{opacity:1;transform:scale(1.1)rotate(288deg);}
  100%{opacity:0;transform:scale(0.6)rotate(360deg);}
}
</style>

</body>
</html>